<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="涉及代码： Google Code:hardware/libhardware/include/hardware/boot_control.hsystem/extras/bootctl/bootctl.cppsystem/extras/boot_control_copy/bootinfo.hsystem/extras/boot_control_copy/bootinfo.csystem/extras">
<meta name="keywords" content="OTA,Boot">
<meta property="og:type" content="article">
<meta property="og:title" content="AB 系统升级之 bootctrl 流程">
<meta property="og:url" content="http://www.xiezeyang.com/2018/12/02/OTA/AB系统升级之bootctrl流程/index.html">
<meta property="og:site_name" content="Young&#39;s Blog">
<meta property="og:description" content="涉及代码： Google Code:hardware/libhardware/include/hardware/boot_control.hsystem/extras/bootctl/bootctl.cppsystem/extras/boot_control_copy/bootinfo.hsystem/extras/boot_control_copy/bootinfo.csystem/extras">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.xiezeyang.com/images/ab-updates-state-machine.png">
<meta property="og:updated_time" content="2019-12-15T11:09:44.571Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AB 系统升级之 bootctrl 流程">
<meta name="twitter:description" content="涉及代码： Google Code:hardware/libhardware/include/hardware/boot_control.hsystem/extras/bootctl/bootctl.cppsystem/extras/boot_control_copy/bootinfo.hsystem/extras/boot_control_copy/bootinfo.csystem/extras">
<meta name="twitter:image" content="http://www.xiezeyang.com/images/ab-updates-state-machine.png">






  <link rel="canonical" href="http://www.xiezeyang.com/2018/12/02/OTA/AB系统升级之bootctrl流程/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>AB 系统升级之 bootctrl 流程 | Young's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Young's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Personal notes</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.xiezeyang.com/2018/12/02/OTA/AB系统升级之bootctrl流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Young">
      <meta itemprop="description" content="自在独行">
      <meta itemprop="image" content="/images/light_house.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Young's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">AB 系统升级之 bootctrl 流程

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-02 00:00:00" itemprop="dateCreated datePublished" datetime="2018-12-02T00:00:00+08:00">2018-12-02</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/OTA/" itemprop="url" rel="index"><span itemprop="name">OTA</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>涉及代码：</p>
<p>Google Code:<br>hardware/libhardware/include/hardware/boot_control.h<br>system/extras/bootctl/bootctl.cpp<br>system/extras/boot_control_copy/bootinfo.h<br>system/extras/boot_control_copy/bootinfo.c<br>system/extras/boot_control_copy/boot_control_copy.c</p>
<p>Qualcomm Code:<br>hardware/qcom/bootctrl/boot_control.cpp</p>
<p>Mediatek Code:<br>vendor/mediatek/hardware/bootctrl/bootctrl.h<br>vendor/mediatek/hardware/bootctrl/bootctrl.cpp</p>
<a id="more"></a>
<p>官网流程图简介：</p>
<p><img src="/images/ab-updates-state-machine.png" alt></p>
<p><1>从misc分区读取boot slot metadata, 若为1/2则执行<2>，否则执行<3></3></2></1></p>
<p><2>选择正确的slot将其设为最高优先级，执行<4></4></2></p>
<p><3>判断是否为正常启动模式，是则执行<5>,否则执行&lt;６&gt;</5></3></p>
<p><4>进入recovery模式</4></p>
<p><5>将boot_successfully标记为1，标记中成功则执行<6>，否则执行<7></7></6></5></p>
<p><6>从active slog加载下一个image，正常启动</6></p>
<p><7>判断retry次数是否大于0，是则减少retry次数继续尝试，否则执行<8></8></7></p>
<p><8>标记slot不正确，回滚至之前的slot</8></p>
<h3 id="一、Bootctrl接口定义"><a href="#一、Bootctrl接口定义" class="headerlink" title="一、Bootctrl接口定义"></a>一、Bootctrl接口定义</h3><p>Hal层bootctrl接口定义位于：hardware/libhardware/include/hardware/boot_control.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">boot_control_module</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> <span class="title">common</span>;</span></span><br><span class="line">    <span class="comment">// HAL层初始化，仅调用一次</span></span><br><span class="line">    <span class="keyword">void</span> (*init)(struct boot_control_module *<span class="keyword">module</span>);</span><br><span class="line">    <span class="comment">// 返回可用的slot数量，A/B为2</span></span><br><span class="line">    <span class="keyword">unsigned</span> (*getNumberSlots)(struct boot_control_module *<span class="keyword">module</span>);</span><br><span class="line">    <span class="comment">// 返回当前系统所处的slot位置，A为0，B为1</span></span><br><span class="line">    <span class="keyword">unsigned</span> (*getCurrentSlot)(struct boot_control_module *<span class="keyword">module</span>);</span><br><span class="line">    <span class="comment">// slot启动成功后标记为0，否则返回error</span></span><br><span class="line">    <span class="keyword">int</span> (*markBootSuccessful)(struct boot_control_module *<span class="keyword">module</span>);</span><br><span class="line">    <span class="comment">// 将slot设置为active boot slot，设置成功返回0，否则返回error</span></span><br><span class="line">    <span class="keyword">int</span> (*setActiveBootSlot)(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot);</span><br><span class="line">    <span class="comment">// 将slot设置为unbootable，设置成功返回0，否则返回error</span></span><br><span class="line">    <span class="keyword">int</span> (*setSlotAsUnbootable)(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot);</span><br><span class="line">    <span class="comment">// 判断slot是否bootable，是则返回1，否则返回0</span></span><br><span class="line">    <span class="keyword">int</span> (*isSlotBootable)(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot);</span><br><span class="line">    <span class="comment">// 获取当前slot对应的suffic，_a或_b</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* (*getSuffix)(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot);</span><br><span class="line">    <span class="comment">// 判断slot是否标记成功，是则返回1，否则返回0</span></span><br><span class="line">    <span class="keyword">int</span> (*isSlotMarkedSuccessful)(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot);</span><br><span class="line">    <span class="keyword">void</span>* reserved[<span class="number">31</span>];</span><br><span class="line">&#125; <span class="keyword">boot_control_module_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="二、Bootctrl的实现－Google方式"><a href="#二、Bootctrl的实现－Google方式" class="headerlink" title="二、Bootctrl的实现－Google方式"></a>二、Bootctrl的实现－Google方式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boot_control_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">  .common = &#123;</span><br><span class="line">    .tag                 = HARDWARE_MODULE_TAG,</span><br><span class="line">    .module_api_version  = BOOT_CONTROL_MODULE_API_VERSION_0_1,</span><br><span class="line">    .hal_api_version     = HARDWARE_HAL_API_VERSION,</span><br><span class="line">    .id                  = BOOT_CONTROL_HARDWARE_MODULE_ID,</span><br><span class="line">    .name                = <span class="string">"Copy Implementation of boot_control HAL"</span>,</span><br><span class="line">    .author              = <span class="string">"The Android Open Source Project"</span>,</span><br><span class="line">    .methods             = &amp;module_methods,</span><br><span class="line">  &#125;,</span><br><span class="line">  .init                 = module_init,</span><br><span class="line">  .getNumberSlots       = module_getNumberSlots,</span><br><span class="line">  .getCurrentSlot       = module_getCurrentSlot,</span><br><span class="line">  .markBootSuccessful   = module_markBootSuccessful,</span><br><span class="line">  .setActiveBootSlot    = module_setActiveBootSlot,</span><br><span class="line">  .setSlotAsUnbootable  = module_setSlotAsUnbootable,</span><br><span class="line">  .isSlotBootable       = module_isSlotBootable,</span><br><span class="line">  .getSuffix            = module_getSuffix,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-module-init"><a href="#2-1-module-init" class="headerlink" title="2.1 module_init"></a>2.1 module_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">module_init</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-module-getNumberSlots"><a href="#2-2-module-getNumberSlots" class="headerlink" title="2.2 module_getNumberSlots"></a>2.2 module_getNumberSlots</h4><p>bootctl get-number-slots</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">module_getNumberSlots</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-module-getCurrentSlot"><a href="#2-3-module-getCurrentSlot" class="headerlink" title="2.3 module_getCurrentSlot"></a>2.3 module_getCurrentSlot</h4><p>bootctl get-current-slot</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">module_getCurrentSlot</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">statbuf</span>;</span></span><br><span class="line">  <span class="keyword">dev_t</span> system_a_dev, system_b_dev;</span><br><span class="line">  <span class="keyword">if</span> (stat(<span class="string">"/system"</span>, &amp;statbuf) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error getting information about /system: %s\n"</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!get_dev_t_for_partition(<span class="string">"system_a"</span>, &amp;system_a_dev) ||</span><br><span class="line">      !get_dev_t_for_partition(<span class="string">"system_b"</span>, &amp;system_b_dev))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (statbuf.st_dev == system_a_dev) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statbuf.st_dev == system_b_dev) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error determining current slot "</span></span><br><span class="line">            <span class="string">"(/system dev_t of %d:%d does not match a=%d:%d or b=%d:%d)\n"</span>,</span><br><span class="line">            major(statbuf.st_dev), minor(statbuf.st_dev),</span><br><span class="line">            major(system_a_dev), minor(system_a_dev),</span><br><span class="line">            major(system_b_dev), minor(system_b_dev));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">get_dev_t_for_partition</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">dev_t</span> *out_device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">statbuf</span>;</span></span><br><span class="line">  <span class="comment">// 从分区表中获取boot信息</span></span><br><span class="line">  fd = boot_info_open_partition(name, <span class="literal">NULL</span>, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (fstat(fd, &amp;statbuf) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error getting information about part %s: %s\n"</span>,</span><br><span class="line">            name, strerror(errno));</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  close(fd);</span><br><span class="line">  *out_device = statbuf.st_rdev;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boot_info_open_partition读取fstab分区表，获取misc挂载点并将其改为boot_a/boot_b等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">boot_info_open_partition</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">uint64_t</span> *out_size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *path;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fstab</span> *<span class="title">fstab</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fstab_rec</span> *<span class="title">record</span>;</span></span><br><span class="line">　<span class="comment">// 打开fstab分区表</span></span><br><span class="line">  fstab = open_fstab();</span><br><span class="line">  <span class="keyword">if</span> (fstab == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// 获取misc分区挂载点信息</span></span><br><span class="line">  record = fs_mgr_get_entry_for_mount_point(fstab, <span class="string">"/misc"</span>);</span><br><span class="line">  <span class="keyword">if</span> (record == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    fs_mgr_free_fstab(fstab);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将misc改为boot_a或boot_b等</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">"misc"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    path = strdup(record-&gt;blk_device);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">size_t</span> trimmed_len, name_len;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *end_slash = <span class="built_in">strrchr</span>(record-&gt;blk_device, <span class="string">'/'</span>);</span><br><span class="line">    <span class="keyword">if</span> (end_slash == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      fs_mgr_free_fstab(fstab);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    trimmed_len = end_slash - record-&gt;blk_device + <span class="number">1</span>;</span><br><span class="line">    name_len = <span class="built_in">strlen</span>(name);</span><br><span class="line">    path = <span class="built_in">calloc</span>(trimmed_len + name_len + <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(path, record-&gt;blk_device, trimmed_len);</span><br><span class="line">    <span class="built_in">strncpy</span>(path + trimmed_len, name, name_len);</span><br><span class="line">  &#125;</span><br><span class="line">  fs_mgr_free_fstab(fstab);</span><br><span class="line">  fd = open(path, flags);</span><br><span class="line">  <span class="built_in">free</span>(path);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span> &amp;&amp; out_size != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, BLKGETSIZE64, out_size) != <span class="number">0</span>) &#123;</span><br><span class="line">      close(fd);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>open_fstab调用fs_mgr_read_fstab方法，读取fstab.device内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct fstab *<span class="title">open_fstab</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fstab</span> *<span class="title">fstab</span> = <span class="title">fs_mgr_read_fstab_default</span>();</span></span><br><span class="line">  <span class="keyword">if</span> (fstab != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> fstab;</span><br><span class="line">  fstab = fs_mgr_read_fstab(<span class="string">"/fstab.device"</span>);</span><br><span class="line">  <span class="keyword">return</span> fstab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-module-markBootSuccessful"><a href="#2-4-module-markBootSuccessful" class="headerlink" title="2.4 module_markBootSuccessful"></a>2.4 module_markBootSuccessful</h4><p>bootctl mark-boot-successful</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">module_markBootSuccessful</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-module-setActiveBootSlot"><a href="#2-5-module-setActiveBootSlot" class="headerlink" title="2.5 module_setActiveBootSlot"></a>2.5 module_setActiveBootSlot</h4><p>bootctl set-active-boot-slot [SLOT]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">module_setActiveBootSlot</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BrilloBootInfo info;</span><br><span class="line">  <span class="keyword">int</span> src_fd, dst_fd;</span><br><span class="line">  <span class="keyword">uint64_t</span> src_size, dst_size;</span><br><span class="line">  <span class="keyword">char</span> src_name[<span class="number">32</span>];</span><br><span class="line">  <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">　<span class="comment">// 若未加载boot信息，则需重置</span></span><br><span class="line">  <span class="keyword">if</span> (!boot_info_load(&amp;info)) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error loading boot-info. Resetting.\n"</span>);</span><br><span class="line">    boot_info_reset(&amp;info);</span><br><span class="line">  <span class="comment">// 若boot信息不合法，则需重置</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!boot_info_validate(&amp;info)) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: boot-info is invalid. Resetting.\n"</span>);</span><br><span class="line">      boot_info_reset(&amp;info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  info.active_slot = slot;</span><br><span class="line">  info.slot_info[slot].bootable = <span class="literal">true</span>;</span><br><span class="line">  <span class="built_in">snprintf</span>(info.bootctrl_suffix,</span><br><span class="line">           <span class="keyword">sizeof</span>(info.bootctrl_suffix),</span><br><span class="line">           <span class="string">"_%c"</span>, slot + <span class="string">'a'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!boot_info_save(&amp;info)) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error saving boot-info.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 拷贝boot_a或boot_b到boot中</span></span><br><span class="line">  <span class="built_in">snprintf</span>(src_name, <span class="keyword">sizeof</span>(src_name), <span class="string">"boot_%c"</span>, slot + <span class="string">'a'</span>);</span><br><span class="line">  src_fd = boot_info_open_partition(src_name, &amp;src_size, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (src_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error opening \"%s\" partition.\n"</span>, src_name);</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  dst_fd = boot_info_open_partition(<span class="string">"boot"</span>, &amp;dst_size, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dst_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error opening \"boot\" partition.\n"</span>);</span><br><span class="line">    close(src_fd);</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (src_size != dst_size) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">            <span class="string">"src (%"</span> PRIu64 <span class="string">" bytes) and dst (%"</span> PRIu64 <span class="string">" bytes) "</span></span><br><span class="line">            <span class="string">"have different sizes.\n"</span>,</span><br><span class="line">            src_size, dst_size);</span><br><span class="line">    close(src_fd);</span><br><span class="line">    close(dst_fd);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 拷贝数据</span></span><br><span class="line">  <span class="keyword">if</span> (!copy_data(src_fd, dst_fd, src_size)) &#123;</span><br><span class="line">    close(src_fd);</span><br><span class="line">    close(dst_fd);</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断内存中数据是否已同步保存</span></span><br><span class="line">  <span class="keyword">if</span> (fsync(dst_fd) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error calling fsync on destination: %s\n"</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  close(src_fd);</span><br><span class="line">  close(dst_fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载boot信息</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">boot_info_load</span><span class="params">(BrilloBootInfo *out_info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="built_in">memset</span>(out_info, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(BrilloBootInfo));</span><br><span class="line">  fd = boot_info_open_partition(<span class="string">"misc"</span>, <span class="literal">NULL</span>, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (lseek(fd, BOOTINFO_OFFSET, SEEK_SET) != BOOTINFO_OFFSET) &#123;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">ssize_t</span> num_read;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    num_read = read(fd, (<span class="keyword">void</span>*) out_info, <span class="keyword">sizeof</span>(BrilloBootInfo));</span><br><span class="line">  &#125; <span class="keyword">while</span> (num_read == <span class="number">-1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">if</span> (num_read != <span class="keyword">sizeof</span>(BrilloBootInfo))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重置boot信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">boot_info_reset</span><span class="params">(BrilloBootInfo* info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>(info, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(BrilloBootInfo));</span><br><span class="line">  info-&gt;magic[<span class="number">0</span>] = <span class="string">'B'</span>;</span><br><span class="line">  info-&gt;magic[<span class="number">1</span>] = <span class="string">'C'</span>;</span><br><span class="line">  info-&gt;magic[<span class="number">2</span>] = <span class="string">'c'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断boot信息是否合法</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">boot_info_validate</span><span class="params">(BrilloBootInfo* info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;magic[<span class="number">0</span>] != <span class="string">'B'</span> ||</span><br><span class="line">      info-&gt;magic[<span class="number">1</span>] != <span class="string">'C'</span> ||</span><br><span class="line">      info-&gt;magic[<span class="number">2</span>] != <span class="string">'c'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;active_slot &gt;= <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否保存boot信息</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">boot_info_save</span><span class="params">(BrilloBootInfo *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  fd = boot_info_open_partition(<span class="string">"misc"</span>, <span class="literal">NULL</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (lseek(fd, BOOTINFO_OFFSET, SEEK_SET) != BOOTINFO_OFFSET) &#123;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">ssize_t</span> num_written;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    num_written = write(fd, (<span class="keyword">void</span>*) info, <span class="keyword">sizeof</span>(BrilloBootInfo));</span><br><span class="line">  &#125; <span class="keyword">while</span> (num_written == <span class="number">-1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">if</span> (num_written != <span class="keyword">sizeof</span>(BrilloBootInfo))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COPY_BUF_SIZE (1024*1024)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">copy_data</span><span class="params">(<span class="keyword">int</span> src_fd, <span class="keyword">int</span> dst_fd, <span class="keyword">size_t</span> num_bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> copy_buf[COPY_BUF_SIZE];</span><br><span class="line">  <span class="keyword">size_t</span> remaining;</span><br><span class="line">  remaining = num_bytes;</span><br><span class="line">  <span class="keyword">while</span> (remaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> num_to_read = remaining &gt; COPY_BUF_SIZE ? COPY_BUF_SIZE : remaining;</span><br><span class="line">    <span class="keyword">ssize_t</span> num_read;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      num_read = read(src_fd, copy_buf, num_to_read);</span><br><span class="line">    &#125; <span class="keyword">while</span> (num_read == <span class="number">-1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">    <span class="keyword">if</span> (num_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error reading %zd bytes from source: %s\n"</span>,</span><br><span class="line">              num_to_read, strerror(errno));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> num_to_write = num_read;</span><br><span class="line">    <span class="keyword">while</span> (num_to_write &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">size_t</span> offset = num_read - num_to_write;</span><br><span class="line">      <span class="keyword">ssize_t</span> num_written;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        num_written = write(dst_fd, copy_buf + offset, num_to_write);</span><br><span class="line">      &#125; <span class="keyword">while</span> (num_written == <span class="number">-1</span> &amp;&amp; errno == EINTR);</span><br><span class="line">      <span class="keyword">if</span> (num_written &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error writing %zd bytes to destination: %s\n"</span>,</span><br><span class="line">                num_to_write, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      num_to_write -= num_written;</span><br><span class="line">    &#125;</span><br><span class="line">    remaining -= num_read;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-module-setSlotAsUnbootable"><a href="#2-6-module-setSlotAsUnbootable" class="headerlink" title="2.6 module_setSlotAsUnbootable"></a>2.6 module_setSlotAsUnbootable</h4><p>bootctl set-slot-as-unbootable [SLOT]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">module_setSlotAsUnbootable</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BrilloBootInfo info;</span><br><span class="line">  <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  <span class="keyword">if</span> (!boot_info_load(&amp;info)) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error loading boot-info. Resetting.\n"</span>);</span><br><span class="line">    boot_info_reset(&amp;info);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!boot_info_validate(&amp;info)) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: boot-info is invalid. Resetting.\n"</span>);</span><br><span class="line">      boot_info_reset(&amp;info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  info.slot_info[slot].bootable = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!boot_info_save(&amp;info)) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error saving boot-info.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> -errno;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-7-module-isSlotBootable"><a href="#2-7-module-isSlotBootable" class="headerlink" title="2.7 module_isSlotBootable"></a>2.7 module_isSlotBootable</h4><p>bootctl is-slot-bootable [SLOT]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">module_isSlotBootable</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BrilloBootInfo info;</span><br><span class="line">  <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  <span class="keyword">if</span> (!boot_info_load(&amp;info)) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: Error loading boot-info. Resetting.\n"</span>);</span><br><span class="line">    boot_info_reset(&amp;info);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!boot_info_validate(&amp;info)) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: boot-info is invalid. Resetting.\n"</span>);</span><br><span class="line">      boot_info_reset(&amp;info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> info.slot_info[slot].bootable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-8-module-getSuffix"><a href="#2-8-module-getSuffix" class="headerlink" title="2.8 module_getSuffix"></a>2.8 module_getSuffix</h4><p>bootctl get-suffix [SLOT]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">module_getSuffix</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* suffix[<span class="number">2</span>] = &#123;<span class="string">"_a"</span>, <span class="string">"_b"</span>&#125;;</span><br><span class="line">  <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> suffix[slot];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、Bootctrl的实现－Qualcomm方式"><a href="#三、Bootctrl的实现－Qualcomm方式" class="headerlink" title="三、Bootctrl的实现－Qualcomm方式"></a>三、Bootctrl的实现－Qualcomm方式</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boot_control_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">    .common = &#123;</span><br><span class="line">        .tag = HARDWARE_MODULE_TAG,</span><br><span class="line">        .module_api_version = <span class="number">1</span>,</span><br><span class="line">        .hal_api_version = <span class="number">0</span>,</span><br><span class="line">        .id = BOOT_CONTROL_HARDWARE_MODULE_ID,</span><br><span class="line">        .name = <span class="string">"Boot control HAL"</span>,</span><br><span class="line">        .author = <span class="string">"Code Aurora Forum"</span>,</span><br><span class="line">        .methods = &amp;boot_control_module_methods,</span><br><span class="line">    &#125;,</span><br><span class="line">    .init = boot_control_init,</span><br><span class="line">    .getNumberSlots = get_number_slots,</span><br><span class="line">    .getCurrentSlot = get_current_slot,</span><br><span class="line">    .markBootSuccessful = mark_boot_successful,</span><br><span class="line">    .setActiveBootSlot = set_active_boot_slot,</span><br><span class="line">    .setSlotAsUnbootable = set_slot_as_unbootable,</span><br><span class="line">    .isSlotBootable = is_slot_bootable,</span><br><span class="line">    .getSuffix = get_suffix,</span><br><span class="line">    .isSlotMarkedSuccessful = is_slot_marked_successful,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-boot-control-init"><a href="#3-1-boot-control-init" class="headerlink" title="3.1 boot_control_init"></a>3.1 boot_control_init</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">boot_control_init</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">module</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Invalid argument passed to %s"</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-get-number-slots"><a href="#3-2-get-number-slots" class="headerlink" title="3.2 get_number_slots"></a>3.2 get_number_slots</h4><p>bootctl get-number-slots</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOTDEV_DIR <span class="meta-string">"/dev/block/bootdevice/by-name"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOT_IMG_PTN_NAME <span class="meta-string">"boot"</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">get_number_slots</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">de</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    DIR *dir_bootdev = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> slot_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">module</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Invalid argument"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    dir_bootdev = opendir(BOOTDEV_DIR);</span><br><span class="line">    <span class="keyword">if</span> (!dir_bootdev) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Failed to open bootdev dir (%s)"</span>,</span><br><span class="line">                __func__,</span><br><span class="line">                strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((de = readdir(dir_bootdev))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (de-&gt;d_name[<span class="number">0</span>] == <span class="string">'.'</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(de-&gt;d_name, BOOT_IMG_PTN_NAME,</span><br><span class="line">                    <span class="built_in">strlen</span>(BOOT_IMG_PTN_NAME)))</span><br><span class="line">            slot_count++;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir_bootdev);</span><br><span class="line">    <span class="keyword">return</span> slot_count;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">if</span> (dir_bootdev)</span><br><span class="line">        closedir(dir_bootdev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-get-current-slot"><a href="#3-3-get-current-slot" class="headerlink" title="3.3 get_current_slot"></a>3.3 get_current_slot</h4><p>bootctl get-current-slot</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *slot_suffix_arr[] = &#123;</span><br><span class="line">    AB_SLOT_A_SUFFIX,</span><br><span class="line">    AB_SLOT_B_SUFFIX,</span><br><span class="line">    <span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">get_current_slot</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> num_slots = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> bootSlotProp[PROPERTY_VALUE_MAX] = &#123;<span class="string">'\0'</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">module</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Invalid argument"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    num_slots = get_number_slots(<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> (num_slots &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    property_get(BOOT_SLOT_PROP, bootSlotProp, <span class="string">"N/A"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(bootSlotProp, <span class="string">"N/A"</span>, <span class="built_in">strlen</span>(<span class="string">"N/A"</span>))) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Unable to read boot slot property"</span>,</span><br><span class="line">                __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; slot_suffix_arr[i] != <span class="literal">NULL</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(bootSlotProp,</span><br><span class="line">                    slot_suffix_arr[i],</span><br><span class="line">                    <span class="built_in">strlen</span>(slot_suffix_arr[i])))</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-mark-boot-successful"><a href="#3-4-mark-boot-successful" class="headerlink" title="3.4 mark_boot_successful"></a>3.4 mark_boot_successful</h4><p>bootctl mark-boot-successful [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mark_boot_successful</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> cur_slot = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">module</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Invalid argument"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    cur_slot = get_current_slot(<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> (update_slot_attribute(slot_suffix_arr[cur_slot],</span><br><span class="line">                ATTR_BOOT_SUCCESSFUL)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">error:</span><br><span class="line">    ALOGE(<span class="string">"%s: Failed to mark boot successful"</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> part_attr_type &#123;</span><br><span class="line">    ATTR_SLOT_ACTIVE = <span class="number">0</span>,</span><br><span class="line">    ATTR_BOOT_SUCCESSFUL,</span><br><span class="line">    ATTR_UNBOOTABLE,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">update_slot_attribute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *slot,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">enum</span> part_attr_type ab_attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[PATH_MAX];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpt_disk</span> *<span class="title">disk</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *pentry = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *pentry_bak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *attr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *attr_bak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> partName[MAX_GPT_NAME_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> ptn_list[][MAX_GPT_NAME_SIZE] = &#123; AB_PTN_LIST &#125;;</span><br><span class="line">    <span class="keyword">int</span> slot_name_valid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!slot) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Invalid argument"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; slot_suffix_arr[i] != <span class="literal">NULL</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(slot, slot_suffix_arr[i],</span><br><span class="line">                    <span class="built_in">strlen</span>(slot_suffix_arr[i])))</span><br><span class="line">                slot_name_valid = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!slot_name_valid) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Invalid slot name"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; ARRAY_SIZE(ptn_list); i++) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>,</span><br><span class="line">                                        <span class="string">"%s/%s%s"</span>,</span><br><span class="line">                                        BOOT_DEV_DIR,</span><br><span class="line">                                        ptn_list[i],</span><br><span class="line">                    AB_SLOT_A_SUFFIX</span><br><span class="line">                    );</span><br><span class="line">        <span class="keyword">if</span> (stat(buf, &amp;st)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>,</span><br><span class="line">                                        <span class="string">"%s/%s%s"</span>,</span><br><span class="line">                                        BOOT_DEV_DIR,</span><br><span class="line">                                        ptn_list[i],</span><br><span class="line">                    AB_SLOT_B_SUFFIX</span><br><span class="line">                    );</span><br><span class="line">        <span class="keyword">if</span> (stat(buf, &amp;st)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(partName, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(partName));</span><br><span class="line">        <span class="built_in">snprintf</span>(partName,</span><br><span class="line">                <span class="keyword">sizeof</span>(partName) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">"%s%s"</span>,</span><br><span class="line">                ptn_list[i],</span><br><span class="line">                slot);</span><br><span class="line">        disk = gpt_disk_alloc();</span><br><span class="line">        <span class="keyword">if</span> (!disk) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to alloc disk struct"</span>,</span><br><span class="line">                    __func__);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        rc = gpt_disk_get_disk_info(partName, disk);</span><br><span class="line">        <span class="keyword">if</span> (rc != <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to get disk info for %s"</span>,</span><br><span class="line">                    __func__,</span><br><span class="line">                    partName);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        pentry = gpt_disk_get_pentry(disk, partName, PRIMARY_GPT);</span><br><span class="line">        pentry_bak = gpt_disk_get_pentry(disk, partName, SECONDARY_GPT);</span><br><span class="line">        <span class="keyword">if</span> (!pentry || !pentry_bak) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to get pentry/pentry_bak for %s"</span>,</span><br><span class="line">                    __func__,</span><br><span class="line">                    partName);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        attr = pentry + AB_FLAG_OFFSET;</span><br><span class="line">        attr_bak = pentry_bak + AB_FLAG_OFFSET;</span><br><span class="line">        <span class="keyword">if</span> (ab_attr == ATTR_BOOT_SUCCESSFUL) &#123;</span><br><span class="line">            *attr = (*attr) | AB_PARTITION_ATTR_BOOT_SUCCESSFUL;</span><br><span class="line">            *attr_bak = (*attr_bak) |</span><br><span class="line">                AB_PARTITION_ATTR_BOOT_SUCCESSFUL;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ab_attr == ATTR_UNBOOTABLE) &#123;</span><br><span class="line">            *attr = (*attr) | AB_PARTITION_ATTR_UNBOOTABLE;</span><br><span class="line">            *attr_bak = (*attr_bak) | AB_PARTITION_ATTR_UNBOOTABLE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ab_attr == ATTR_SLOT_ACTIVE) &#123;</span><br><span class="line">            *attr = (*attr) | AB_PARTITION_ATTR_SLOT_ACTIVE;</span><br><span class="line">            *attr_bak = (*attr) | AB_PARTITION_ATTR_SLOT_ACTIVE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Unrecognized attr"</span>, __func__);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (gpt_disk_update_crc(disk)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to update crc for %s"</span>,</span><br><span class="line">                    __func__,</span><br><span class="line">                    partName);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (gpt_disk_commit(disk)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to write back entry for %s"</span>,</span><br><span class="line">                    __func__,</span><br><span class="line">                    partName);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">        disk = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">if</span> (disk)</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-set-active-boot-slot"><a href="#3-5-set-active-boot-slot" class="headerlink" title="3.5 set_active_boot_slot"></a>3.5 set_active_boot_slot</h4><p>bootctl set-active-boot-slot [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">set_active_boot_slot</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&gt; ptn_map;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; ptn_vec;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> ptn_list[][MAX_GPT_NAME_SIZE] = &#123; AB_PTN_LIST &#125;;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> is_ufs = gpt_utils_is_ufs_device();</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&gt;::iterator map_iter;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;::iterator string_iter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (boot_control_check_slot_sanity(<span class="keyword">module</span>, slot)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Bad arguments"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(ptn_list); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_ufs &amp;&amp; !<span class="built_in">strncmp</span>(ptn_list[i], PTN_XBL, <span class="built_in">strlen</span>(PTN_XBL)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">string</span> cur_ptn = ptn_list[i];</span><br><span class="line">        cur_ptn.append(AB_SLOT_A_SUFFIX);</span><br><span class="line">        ptn_vec.push_back(cur_ptn);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (gpt_utils_get_partition_map(ptn_vec, ptn_map)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Failed to get partition map"</span>,</span><br><span class="line">                __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (map_iter = ptn_map.begin(); map_iter != ptn_map.end(); map_iter++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (map_iter-&gt;second.size() &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        boot_ctl_set_active_slot_for_partitions(map_iter-&gt;second, slot);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_ufs) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(slot_suffix_arr[slot], AB_SLOT_A_SUFFIX,</span><br><span class="line">                    <span class="built_in">strlen</span>(AB_SLOT_A_SUFFIX)))&#123;</span><br><span class="line">            rc = gpt_utils_set_xbl_boot_partition(NORMAL_BOOT);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(slot_suffix_arr[slot], AB_SLOT_B_SUFFIX,</span><br><span class="line">                    <span class="built_in">strlen</span>(AB_SLOT_B_SUFFIX)))&#123;</span><br><span class="line">            rc = gpt_utils_set_xbl_boot_partition(BACKUP_BOOT);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Unknown slot suffix!"</span>, __func__);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Failed to switch xbl boot partition"</span>,</span><br><span class="line">                    __func__);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">boot_control_check_slot_sanity</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">module</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> num_slots = get_number_slots(<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> ((num_slots &lt; <span class="number">1</span>) || (slot &gt; num_slots - <span class="number">1</span>)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Invalid slot number"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">boot_ctl_set_active_slot_for_partitions</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; part_list,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[PATH_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpt_disk</span> *<span class="title">disk</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">char</span> slotA[MAX_GPT_NAME_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> slotB[MAX_GPT_NAME_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> active_guid[TYPE_GUID_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> inactive_guid[TYPE_GUID_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">uint8_t</span> *pentryA = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *pentryA_bak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *pentryB = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *pentryB_bak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;::iterator partition_iterator;</span><br><span class="line">    <span class="keyword">for</span> (partition_iterator = part_list.begin();</span><br><span class="line">            partition_iterator != part_list.end();</span><br><span class="line">            partition_iterator++) &#123;</span><br><span class="line">        <span class="built_in">string</span> prefix = *partition_iterator;</span><br><span class="line">        <span class="keyword">if</span> (prefix.size() &lt; (<span class="built_in">strlen</span>(AB_SLOT_A_SUFFIX) + <span class="number">1</span>)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Invalid partition name: %s"</span>, prefix.c_str());</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        prefix.resize(prefix.size() - <span class="built_in">strlen</span>(AB_SLOT_A_SUFFIX));</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="string">"%s/%s%s"</span>, BOOT_DEV_DIR,</span><br><span class="line">                prefix.c_str(),</span><br><span class="line">                AB_SLOT_A_SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (stat(buf, &amp;st))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="string">"%s/%s%s"</span>, BOOT_DEV_DIR,</span><br><span class="line">                prefix.c_str(),</span><br><span class="line">                AB_SLOT_B_SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (stat(buf, &amp;st))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">memset</span>(slotA, <span class="number">0</span>, <span class="keyword">sizeof</span>(slotA));</span><br><span class="line">        <span class="built_in">memset</span>(slotB, <span class="number">0</span>, <span class="keyword">sizeof</span>(slotA));</span><br><span class="line">        <span class="built_in">snprintf</span>(slotA, <span class="keyword">sizeof</span>(slotA) - <span class="number">1</span>, <span class="string">"%s%s"</span>, prefix.c_str(),</span><br><span class="line">                AB_SLOT_A_SUFFIX);</span><br><span class="line">        <span class="built_in">snprintf</span>(slotB, <span class="keyword">sizeof</span>(slotB) - <span class="number">1</span>,<span class="string">"%s%s"</span>, prefix.c_str(),</span><br><span class="line">                AB_SLOT_B_SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (!disk) &#123;</span><br><span class="line">            disk = boot_ctl_get_disk_info(slotA);</span><br><span class="line">            <span class="keyword">if</span> (!disk)</span><br><span class="line">                <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        pentryA = gpt_disk_get_pentry(disk, slotA, PRIMARY_GPT);</span><br><span class="line">        pentryA_bak = gpt_disk_get_pentry(disk, slotA, SECONDARY_GPT);</span><br><span class="line">        pentryB = gpt_disk_get_pentry(disk, slotB, PRIMARY_GPT);</span><br><span class="line">        pentryB_bak = gpt_disk_get_pentry(disk, slotB, SECONDARY_GPT);</span><br><span class="line">        <span class="keyword">if</span> ( !pentryA || !pentryA_bak || !pentryB || !pentryB_bak) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Slot pentries for %s not found."</span>,</span><br><span class="line">                    prefix.c_str());</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(active_guid, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(active_guid));</span><br><span class="line">        <span class="built_in">memset</span>(inactive_guid, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(inactive_guid));</span><br><span class="line">        <span class="keyword">if</span> (get_partition_attribute(slotA, ATTR_SLOT_ACTIVE) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)active_guid, (<span class="keyword">const</span> <span class="keyword">void</span>*)pentryA,</span><br><span class="line">                    TYPE_GUID_SIZE);</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)inactive_guid,(<span class="keyword">const</span> <span class="keyword">void</span>*)pentryB,</span><br><span class="line">                    TYPE_GUID_SIZE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (get_partition_attribute(slotB,</span><br><span class="line">                    ATTR_SLOT_ACTIVE) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)active_guid, (<span class="keyword">const</span> <span class="keyword">void</span>*)pentryB,</span><br><span class="line">                    TYPE_GUID_SIZE);</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)inactive_guid, (<span class="keyword">const</span> <span class="keyword">void</span>*)pentryA,</span><br><span class="line">                    TYPE_GUID_SIZE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"Both A &amp; B are inactive..Aborting"</span>);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(slot_suffix_arr[slot], AB_SLOT_A_SUFFIX,</span><br><span class="line">                    <span class="built_in">strlen</span>(AB_SLOT_A_SUFFIX)))&#123;</span><br><span class="line">            UPDATE_SLOT(pentryA, active_guid, SLOT_ACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryA_bak, active_guid, SLOT_ACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryB, inactive_guid, SLOT_INACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryB_bak, inactive_guid, SLOT_INACTIVE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(slot_suffix_arr[slot], AB_SLOT_B_SUFFIX,</span><br><span class="line">                    <span class="built_in">strlen</span>(AB_SLOT_B_SUFFIX)))&#123;</span><br><span class="line">            UPDATE_SLOT(pentryB, active_guid, SLOT_ACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryB_bak, active_guid, SLOT_ACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryA, inactive_guid, SLOT_INACTIVE);</span><br><span class="line">            UPDATE_SLOT(pentryA_bak, inactive_guid, SLOT_INACTIVE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Unknown slot suffix!"</span>, __func__);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (disk) &#123;</span><br><span class="line">            <span class="keyword">if</span> (gpt_disk_update_crc(disk) != <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">"%s: Failed to update gpt_disk crc"</span>,</span><br><span class="line">                        __func__);</span><br><span class="line">                <span class="keyword">goto</span> error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (disk) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gpt_disk_commit(disk)) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Failed to commit disk entry"</span>);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">if</span> (disk)</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get_partition_attribute</span><span class="params">(<span class="keyword">char</span> *partname,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">enum</span> part_attr_type part_attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpt_disk</span> *<span class="title">disk</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *pentry = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *attr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!partname)</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    disk = gpt_disk_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!disk) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Failed to alloc disk struct"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (gpt_disk_get_disk_info(partname, disk)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Failed to get disk info"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    pentry = gpt_disk_get_pentry(disk, partname, PRIMARY_GPT);</span><br><span class="line">    <span class="keyword">if</span> (!pentry) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: pentry does not exist in disk struct"</span>,</span><br><span class="line">                __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    attr = pentry + AB_FLAG_OFFSET;</span><br><span class="line">    <span class="keyword">if</span> (part_attr == ATTR_SLOT_ACTIVE)</span><br><span class="line">        retval = !!(*attr &amp; AB_PARTITION_ATTR_SLOT_ACTIVE);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (part_attr == ATTR_BOOT_SUCCESSFUL)</span><br><span class="line">        retval = !!(*attr &amp; AB_PARTITION_ATTR_BOOT_SUCCESSFUL);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (part_attr == ATTR_UNBOOTABLE)</span><br><span class="line">        retval = !!(*attr &amp; AB_PARTITION_ATTR_UNBOOTABLE);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        retval = <span class="number">-1</span>;</span><br><span class="line">    gpt_disk_free(disk);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">if</span> (disk)</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct gpt_disk* <span class="title">boot_ctl_get_disk_info</span><span class="params">(<span class="keyword">char</span> *partition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpt_disk</span> *<span class="title">disk</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!partition)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    disk = gpt_disk_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!disk) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Failed to alloc disk"</span>,</span><br><span class="line">                __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (gpt_disk_get_disk_info(partition, disk)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"failed to get disk info for %s"</span>,</span><br><span class="line">                partition);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> disk;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">if</span> (disk)</span><br><span class="line">        gpt_disk_free(disk);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-6-set-slot-as-unbootable"><a href="#3-6-set-slot-as-unbootable" class="headerlink" title="3.6 set_slot_as_unbootable"></a>3.6 set_slot_as_unbootable</h4><p>bootctl set-slot-as-unbootable [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">set_slot_as_unbootable</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (boot_control_check_slot_sanity(<span class="keyword">module</span>, slot) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Argument check failed"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (update_slot_attribute(slot_suffix_arr[slot],</span><br><span class="line">                ATTR_UNBOOTABLE)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">error:</span><br><span class="line">    ALOGE(<span class="string">"%s: Failed to mark slot unbootable"</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-7-is-slot-bootable"><a href="#3-7-is-slot-bootable" class="headerlink" title="3.7 is_slot_bootable"></a>3.7 is_slot_bootable</h4><p>bootctl is-slot-bootable [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_slot_bootable</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> attr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> bootPartition[MAX_GPT_NAME_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (boot_control_check_slot_sanity(<span class="keyword">module</span>, slot) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Argument check failed"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(bootPartition,</span><br><span class="line">            <span class="keyword">sizeof</span>(bootPartition) - <span class="number">1</span>, <span class="string">"boot%s"</span>,</span><br><span class="line">            slot_suffix_arr[slot]);</span><br><span class="line">    attr = get_partition_attribute(bootPartition, ATTR_UNBOOTABLE);</span><br><span class="line">    <span class="keyword">if</span> (attr &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> !attr;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-8-get-suffix"><a href="#3-8-get-suffix" class="headerlink" title="3.8 get_suffix"></a>3.8 get_suffix</h4><p>bootctl get-suffix</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">get_suffix</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (boot_control_check_slot_sanity(<span class="keyword">module</span>, slot) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> slot_suffix_arr[slot];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-9-is-slot-marked-successful"><a href="#3-9-is-slot-marked-successful" class="headerlink" title="3.9 is_slot_marked_successful"></a>3.9 is_slot_marked_successful</h4><p>bootctl is-slot-marked-successful [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_slot_marked_successful</span><span class="params">(struct boot_control_module *<span class="keyword">module</span>, <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> attr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> bootPartition[MAX_GPT_NAME_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (boot_control_check_slot_sanity(<span class="keyword">module</span>, slot) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Argument check failed"</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(bootPartition,</span><br><span class="line">            <span class="keyword">sizeof</span>(bootPartition) - <span class="number">1</span>,</span><br><span class="line">            <span class="string">"boot%s"</span>, slot_suffix_arr[slot]);</span><br><span class="line">    attr = get_partition_attribute(bootPartition, ATTR_BOOT_SUCCESSFUL);</span><br><span class="line">    <span class="keyword">if</span> (attr &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> attr;</span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、Bootctrl的实现－Mediatek方式"><a href="#四、Bootctrl的实现－Mediatek方式" class="headerlink" title="四、Bootctrl的实现－Mediatek方式"></a>四、Bootctrl的实现－Mediatek方式</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boot_control_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">    .common = &#123;</span><br><span class="line">        .tag                 = HARDWARE_MODULE_TAG,</span><br><span class="line">        .module_api_version  = BOOT_CONTROL_MODULE_API_VERSION_0_1,</span><br><span class="line">        .hal_api_version     = HARDWARE_HAL_API_VERSION,</span><br><span class="line">        .id                  = BOOT_CONTROL_HARDWARE_MODULE_ID,</span><br><span class="line">        .name                = <span class="string">"boot_control HAL"</span>,</span><br><span class="line">        .author              = <span class="string">"Mediatek Corporation"</span>,</span><br><span class="line">        .methods             = &amp;bootctrl_methods,</span><br><span class="line">    &#125;,</span><br><span class="line">    .init                 = bootctrl_init,</span><br><span class="line">    .getNumberSlots       = bootctrl_get_number_slots,</span><br><span class="line">    .getCurrentSlot       = bootctrl_get_current_slot,</span><br><span class="line">    .markBootSuccessful   = bootctrl_mark_boot_successful,</span><br><span class="line">    .setActiveBootSlot    = bootctrl_set_active_boot_slot,</span><br><span class="line">    .setSlotAsUnbootable  = bootctrl_set_slot_as_unbootable,</span><br><span class="line">    .isSlotBootable       = bootctrl_is_slot_bootable,</span><br><span class="line">    .isSlotMarkedSuccessful = bootctrl_get_bootup_status,</span><br><span class="line">    .getSuffix            = bootctrl_get_suffix,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-bootctrl-init"><a href="#4-1-bootctrl-init" class="headerlink" title="4.1 bootctrl_init"></a>4.1 bootctrl_init</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bootctrl_init</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control HAL init"</span>);</span><br><span class="line">    <span class="keyword">if</span>　(blk_dev_path == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化fstab</span></span><br><span class="line">        fstab = fs_mgr_read_fstab_default();</span><br><span class="line">        <span class="keyword">if</span> (!fstab) &#123;</span><br><span class="line">            ALOGE(<span class="string">"failed to read default fstab"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        blk_dev_path = get_device_path(<span class="string">"/misc"</span>);</span><br><span class="line">        <span class="comment">// 释放fstab</span></span><br><span class="line">        free_fstab();</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGI(<span class="string">"%s misc blk device path = %s\n"</span>, __func__ ,blk_dev_path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">get_device_path</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *mount_point)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fstab_rec</span> *<span class="title">rec</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *source = <span class="literal">NULL</span>;</span><br><span class="line">    rec = fs_mgr_get_entry_for_mount_point(fstab, mount_point);</span><br><span class="line">    <span class="keyword">if</span> (!rec) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s failed to get entry for %s \n"</span>, __func__ , mount_point);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    source = strdup(rec-&gt;blk_device);</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-bootctrl-get-number-slots"><a href="#4-2-bootctrl-get-number-slots" class="headerlink" title="4.2 bootctrl_get_number_slots"></a>4.2 bootctrl_get_number_slots</h4><p>bootctl get-number-slots</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">bootctrl_get_number_slots</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-bootctrl-get-current-slot"><a href="#4-3-bootctrl-get-current-slot" class="headerlink" title="4.3 bootctrl_get_current_slot"></a>4.3 bootctrl_get_current_slot</h4><p>bootctl get-current-slot</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> bootctrl_get_current_slot(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_get_current_slot\n"</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> slot = <span class="number">0</span>;</span><br><span class="line">    slot = bootctrl_get_active_slot();</span><br><span class="line">    ALOGI(<span class="string">"bootctrl_get_current_slot %d\n"</span>, slot);</span><br><span class="line">    <span class="keyword">return</span> slot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOT_SUFFIX_STR <span class="meta-string">"androidboot.slot_suffix="</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_get_active_slot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, err, slot;</span><br><span class="line">    <span class="keyword">ssize_t</span> size = COMMAND_LINE_SIZE, sz;</span><br><span class="line">    <span class="keyword">off_t</span> off;</span><br><span class="line">    <span class="keyword">char</span> *buf, *ptr;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    fd = open(COMMAND_LINE_PATH, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = -errno;</span><br><span class="line">        ALOGE(<span class="string">"%s error reading commandline\n"</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    ptr = buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span> (!buf) &#123;</span><br><span class="line">        err = -errno;</span><br><span class="line">        ALOGE(<span class="string">"%s Error allocating memory\n"</span>, __func__);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sz = read(fd, buf, size);</span><br><span class="line">        <span class="keyword">if</span> (sz == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sz &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            err = -errno;</span><br><span class="line">            ALOGE(<span class="string">"%s Error reading file\n"</span>,__func__);</span><br><span class="line">            <span class="built_in">free</span>(ptr);</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        size -= sz;</span><br><span class="line">        buf += sz;</span><br><span class="line">    &#125; <span class="keyword">while</span>(size &gt; <span class="number">0</span>);</span><br><span class="line">    str = <span class="built_in">strstr</span>((<span class="keyword">char</span> *)ptr, SLOT_SUFFIX_STR);</span><br><span class="line">    <span class="keyword">if</span> (!str) &#123;</span><br><span class="line">        err = -EIO;</span><br><span class="line">        ALOGE(<span class="string">"%s cannot find %s in kernel commandline.\n"</span>, __func__ , SLOT_SUFFIX_STR);</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    str += <span class="keyword">sizeof</span>(SLOT_SUFFIX_STR);</span><br><span class="line">    slot = (*str == <span class="string">'a'</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> slot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-4-bootctrl-mark-boot-successful"><a href="#4-4-bootctrl-mark-boot-successful" class="headerlink" title="4.4 bootctrl_mark_boot_successful"></a>4.4 bootctrl_mark_boot_successful</h4><p>bootctl mark-boot-successful [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_mark_boot_successful</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_mark_boot_successful\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">uint32_t</span> slot = <span class="number">0</span>;</span><br><span class="line">    AvbABData metadata;</span><br><span class="line">    AvbABSlotData *slotp;</span><br><span class="line">    ret = bootctrl_read_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    slot = bootctrl_get_active_slot();</span><br><span class="line">    <span class="keyword">if</span> (slot &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"bootctrl_mark_boot_successful fail , slot = \n"</span>);</span><br><span class="line">        <span class="keyword">return</span> slot;</span><br><span class="line">    &#125;</span><br><span class="line">    slotp = &amp;metadata.slots[slot];</span><br><span class="line">    slotp-&gt;successful_boot = <span class="number">1</span>;</span><br><span class="line">    slotp-&gt;tries_remaining = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> bootctrl_write_metadata(&amp;metadata);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bootctrl_read_metadata</span><span class="params">(AvbABData *bctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, err;</span><br><span class="line">    <span class="keyword">ssize_t</span> sz, size;</span><br><span class="line">    <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)bctrl;</span><br><span class="line">    fd = open(blk_dev_path, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = errno;</span><br><span class="line">        ALOGE(<span class="string">"%s Error opening metadata file: %s\n"</span>, __func__ ,strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> -err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, OFFSETOF_SLOT_SUFFIX, SEEK_SET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = errno;</span><br><span class="line">        ALOGE(<span class="string">"%s Error seeking to metadata offset: %s\n"</span>, __func__ ,strerror(errno));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -err;</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="keyword">sizeof</span>(AvbABData);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sz = read(fd, buf, size);</span><br><span class="line">        <span class="keyword">if</span> (sz == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sz &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            err = -errno;</span><br><span class="line">            ALOGE(<span class="string">"%s Error reading metadata file\n"</span>, __func__);</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        size -= sz;</span><br><span class="line">        buf += sz;</span><br><span class="line">    &#125; <span class="keyword">while</span>(size &gt; <span class="number">0</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="comment">// 检查bootctrl magic数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">memcmp</span>(bctrl-&gt;magic , AVB_AB_MAGIC, AVB_AB_MAGIC_LEN) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"metadata is not initialised or corrupted %x.\n"</span>, bctrl-&gt;magic);</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bootctrl_write_metadata</span><span class="params">(AvbABData *bctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, err;</span><br><span class="line">    <span class="keyword">ssize_t</span> sz, size;</span><br><span class="line">    <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)bctrl;</span><br><span class="line">    fd = open(blk_dev_path, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = errno;</span><br><span class="line">        ALOGE(<span class="string">"%s Error opening metadata file: %s\n"</span>, __func__,strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> -err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, OFFSETOF_SLOT_SUFFIX, SEEK_SET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = errno;</span><br><span class="line">        ALOGE(<span class="string">"%s Error seeking to metadata offset: %s\n"</span>, __func__ ,strerror(errno));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -err;</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="keyword">sizeof</span>(AvbABData);</span><br><span class="line">    bctrl-&gt;crc32 = avb_htobe32(</span><br><span class="line">             avb_crc32((<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)bctrl, <span class="keyword">sizeof</span>(AvbABData) - <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>)));</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sz = write(fd, buf, size);</span><br><span class="line">        <span class="keyword">if</span> (sz == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sz &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            err = -errno;</span><br><span class="line">            ALOGE(<span class="string">"%s Error Writing metadata file\n"</span>,__func__);</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        size -= sz;</span><br><span class="line">        buf += sz;</span><br><span class="line">    &#125; <span class="keyword">while</span>(size &gt; <span class="number">0</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-5-bootctrl-set-active-boot-slot"><a href="#4-5-bootctrl-set-active-boot-slot" class="headerlink" title="4.5 bootctrl_set_active_boot_slot"></a>4.5 bootctrl_set_active_boot_slot</h4><p>bootctl set-active-boot-slot [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_set_active_boot_slot</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_set_active_boot_slot , slot is %d\n"</span>, slot);</span><br><span class="line">    <span class="keyword">int</span> ret, slot2;</span><br><span class="line">    AvbABData metadata;</span><br><span class="line">    AvbABSlotData *slotp;</span><br><span class="line">    <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s Wrong Slot value %u\n"</span>, __func__ , slot);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = bootctrl_read_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置最高优先级并重置retry次数</span></span><br><span class="line">    slotp = &amp;metadata.slots[slot];</span><br><span class="line">    slotp-&gt;successful_boot = <span class="number">0</span>;</span><br><span class="line">    slotp-&gt;priority = AVB_AB_MAX_PRIORITY;</span><br><span class="line">    slotp-&gt;tries_remaining = AVB_AB_MAX_TRIES_REMAINING;</span><br><span class="line">    <span class="comment">// 确保其它slot没有更高优先级</span></span><br><span class="line">    slot2 = (slot == <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    slotp = &amp;metadata.slots[slot2];</span><br><span class="line">    <span class="keyword">if</span>(slotp-&gt;priority == AVB_AB_MAX_PRIORITY)</span><br><span class="line">        slotp-&gt;priority = AVB_AB_MAX_PRIORITY - <span class="number">1</span>;</span><br><span class="line">    ret = bootctrl_write_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = switch_pl_boot_part(slot);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"bootctrl_set_active_boot_slot switch boot part fail\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">switch_pl_boot_part</span><span class="params">(<span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> propbuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> boot_part = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// slot 0即A，slot 1即B</span></span><br><span class="line">    <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s Wrong Slot value %u\n"</span>, __func__ , slot);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(slot)</span><br><span class="line">      boot_part = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      boot_part = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// EMMC</span></span><br><span class="line">    property_get(<span class="string">"ro.mtk_emmc_support"</span>, propbuf, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(propbuf, <span class="string">"1"</span>,<span class="number">1</span>)) &#123;</span><br><span class="line">        ALOGI(<span class="string">"emmc_set_active_boot_part\n"</span>);</span><br><span class="line">        ret = emmc_set_active_boot_part(slot);</span><br><span class="line">        <span class="keyword">if</span>(ret) &#123;</span><br><span class="line">            ALOGE(<span class="string">"emmc set boot_part fail\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// UFS</span></span><br><span class="line">    property_get(<span class="string">"ro.mtk_ufs_booting"</span>, propbuf, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(propbuf, <span class="string">"1"</span>,<span class="number">1</span>)) &#123;</span><br><span class="line">        ALOGI (<span class="string">"mtk_ufs propbuf\n"</span>);</span><br><span class="line">        ret = ufs_set_active_boot_part(boot_part);</span><br><span class="line">        <span class="keyword">if</span>(ret) &#123;</span><br><span class="line">            ALOGE(<span class="string">"ufs set boot_part fail\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGE(<span class="string">"Un support phone type\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">emmc_set_active_boot_part</span><span class="params">(<span class="keyword">int</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msdc_ioctl</span> <span class="title">st_ioctl_arg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> bootpart = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/misc-sd"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;st_ioctl_arg,<span class="number">0</span>,<span class="keyword">sizeof</span>(struct msdc_ioctl));</span><br><span class="line">        st_ioctl_arg.host_num = <span class="number">0</span>;</span><br><span class="line">        st_ioctl_arg.opcode = MSDC_SET_BOOTPART;</span><br><span class="line">        st_ioctl_arg.total_size = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (slot)</span><br><span class="line">            bootpart = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            bootpart = <span class="number">1</span>;</span><br><span class="line">        st_ioctl_arg.buffer = &amp;bootpart;</span><br><span class="line">        <span class="keyword">int</span> ret = ioctl(fd, MSDC_SET_BOOTPART, &amp;st_ioctl_arg);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"ioctl boot_part fail: %s\n"</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ALOGE(<span class="string">"switch bootpart to  = %d, ret = %d\n"</span>, bootpart, ret);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(<span class="string">"open /dev/misc-sd fail\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ufs_set_active_boot_part</span><span class="params">(<span class="keyword">int</span> boot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ufs_ioctl_query_data</span> <span class="title">idata</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> fd, ret = <span class="number">0</span>;</span><br><span class="line">    fd = open(<span class="string">"/dev/block/sdc"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: open device failed, err: %d\n"</span>, __func__, fd);</span><br><span class="line">        ret = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = boot;           <span class="comment">/* 1: BootLU A, 2: BootLU B */</span></span><br><span class="line">    idata.opcode = UPIU_QUERY_OPCODE_WRITE_ATTR;</span><br><span class="line">    idata.idn = QUERY_ATTR_IDN_BOOT_LUN_EN;</span><br><span class="line">    idata.idx = <span class="number">0</span>;</span><br><span class="line">    idata.buf_ptr = &amp;buf[<span class="number">0</span>];</span><br><span class="line">    idata.buf_byte = <span class="number">1</span>;</span><br><span class="line">    ret = ioctl(fd, UFS_IOCTL_QUERY, &amp;idata);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ufs_set boot_part fail: %s\n"</span>, strerror(errno));</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">if</span>(fd &gt;= <span class="number">0</span>)</span><br><span class="line">        close(fd);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-6-bootctrl-set-slot-as-unbootable"><a href="#4-6-bootctrl-set-slot-as-unbootable" class="headerlink" title="4.6 bootctrl_set_slot_as_unbootable"></a>4.6 bootctrl_set_slot_as_unbootable</h4><p>bootctl set-slot-as-unbootable [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_set_slot_as_unbootable</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_set_slot_as_unbootable\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    AvbABData metadata;</span><br><span class="line">    AvbABSlotData *slotp;</span><br><span class="line">    <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s Wrong Slot value %u\n"</span>, __func__ , slot);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = bootctrl_read_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将优先级，successful_boot，tries_remaining均设为0</span></span><br><span class="line">    slotp = &amp;metadata.slots[slot];</span><br><span class="line">    slotp-&gt;successful_boot = <span class="number">0</span>;</span><br><span class="line">    slotp-&gt;priority = <span class="number">0</span>;</span><br><span class="line">    slotp-&gt;tries_remaining = <span class="number">0</span>;</span><br><span class="line">    ret = bootctrl_write_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-7-bootctrl-is-slot-bootable"><a href="#4-7-bootctrl-is-slot-bootable" class="headerlink" title="4.7 bootctrl_is_slot_bootable"></a>4.7 bootctrl_is_slot_bootable</h4><p>bootctl is-slot-bootable [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_is_slot_bootable</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_is_slot_bootable\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    AvbABData metadata;</span><br><span class="line">    <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s Wrong slot value %u\n"</span>, __func__,slot);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = bootctrl_read_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (metadata.slots[slot].priority != <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-8-bootctrl-get-bootup-status"><a href="#4-8-bootctrl-get-bootup-status" class="headerlink" title="4.8 bootctrl_get_bootup_status"></a>4.8 bootctrl_get_bootup_status</h4><p>bootctl is-slot-marked-successful [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bootctrl_get_bootup_status</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"bootctrl bootctrl_get_bootup_status\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    AvbABSlotData *slotp;</span><br><span class="line">    AvbABData metadata;</span><br><span class="line">    <span class="keyword">if</span>(slot &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s Wrong slot value %u\n"</span>, __func__,slot);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = bootctrl_read_metadata(&amp;metadata);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    slotp = &amp;metadata.slots[slot];</span><br><span class="line">    ALOGI(<span class="string">"bootctrl bootctrl_get_bootup_status = %d\n"</span>, slotp-&gt;successful_boot);</span><br><span class="line">    <span class="keyword">return</span> slotp-&gt;successful_boot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-9-bootctrl-get-suffix"><a href="#4-9-bootctrl-get-suffix" class="headerlink" title="4.9 bootctrl_get_suffix"></a>4.9 bootctrl_get_suffix</h4><p>bootctl get-suffix [SLOT]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">bootctrl_get_suffix</span><span class="params">(<span class="keyword">boot_control_module_t</span> *<span class="keyword">module</span> __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> slot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">"boot control bootctrl_get_suffix\n"</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* suffix[<span class="number">2</span>] = &#123;BOOTCTRL_SUFFIX_A, BOOTCTRL_SUFFIX_B&#125;;</span><br><span class="line">    <span class="keyword">if</span> (slot &gt;= <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> suffix[slot];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、Bootctrl的测试－bootctl-command"><a href="#五、Bootctrl的测试－bootctl-command" class="headerlink" title="五、Bootctrl的测试－bootctl command"></a>五、Bootctrl的测试－bootctl command</h3><p>AOSP提供bootctl工具用于测试bootctrl，adb bootctl command(需要root权限)。<br>代码位于：system/extras/bootctl/bootctl.cpp</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">~$ adb root</span><br><span class="line">adbd is already running as root</span><br><span class="line"></span><br><span class="line">~$ adb shell</span><br><span class="line"><span class="function">android:/ # <span class="title">bootctl</span></span></span><br><span class="line"><span class="function"><span class="title">bootctl</span> - <span class="title">command</span>-<span class="title">line</span> <span class="title">wrapper</span> <span class="title">for</span> <span class="title">the</span> <span class="title">boot</span> <span class="title">HAL</span>.</span></span><br><span class="line"><span class="function"><span class="title">Usage</span>:</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">COMMAND</span></span></span><br><span class="line"><span class="function"><span class="title">Commands</span>:</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">hal</span>-<span class="title">info</span>                       - <span class="title">Show</span> <span class="title">info</span> <span class="title">about</span> <span class="title">boot_control</span> <span class="title">HAL</span> <span class="title">used</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">number</span>-<span class="title">slots</span>               - <span class="title">Prints</span> <span class="title">number</span> <span class="title">of</span> <span class="title">slots</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">current</span>-<span class="title">slot</span>               - <span class="title">Prints</span> <span class="title">currently</span> <span class="title">running</span> <span class="title">SLOT</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">mark</span>-<span class="title">boot</span>-<span class="title">successful</span>           - <span class="title">Mark</span> <span class="title">current</span> <span class="title">slot</span> <span class="title">as</span> <span class="title">GOOD</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">set</span>-<span class="title">active</span>-<span class="title">boot</span>-<span class="title">slot</span> <span class="title">SLOT</span>      - <span class="title">On</span> <span class="title">next</span> <span class="title">boot</span>, <span class="title">load</span> <span class="title">and</span> <span class="title">execute</span> <span class="title">SLOT</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">set</span>-<span class="title">slot</span>-<span class="title">as</span>-<span class="title">unbootable</span> <span class="title">SLOT</span>    - <span class="title">Mark</span> <span class="title">SLOT</span> <span class="title">as</span> <span class="title">invalid</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">is</span>-<span class="title">slot</span>-<span class="title">bootable</span> <span class="title">SLOT</span>          - <span class="title">Returns</span> 0 <span class="title">only</span> <span class="title">if</span> <span class="title">SLOT</span> <span class="title">is</span> <span class="title">bootable</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">is</span>-<span class="title">slot</span>-<span class="title">marked</span>-<span class="title">successful</span> <span class="title">SLOT</span> - <span class="title">Returns</span> 0 <span class="title">only</span> <span class="title">if</span> <span class="title">SLOT</span> <span class="title">is</span> <span class="title">marked</span> <span class="title">GOOD</span>.</span></span><br><span class="line"><span class="function">  <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">suffix</span> <span class="title">SLOT</span>                - <span class="title">Prints</span> <span class="title">suffix</span> <span class="title">for</span> <span class="title">SLOT</span>.</span></span><br><span class="line"><span class="function"><span class="title">SLOT</span> <span class="title">parameter</span> <span class="title">is</span> <span class="title">the</span> <span class="title">zero</span>-<span class="title">based</span> <span class="title">slot</span>-<span class="title">number</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">hal</span>-<span class="title">info</span></span></span><br><span class="line"><span class="function"><span class="title">HAL</span> <span class="title">Version</span>: <span class="title">android.hardware.boot</span>@1.0::<span class="title">IBootControl</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">number</span>-<span class="title">slots</span></span></span><br><span class="line"><span class="function">2</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">current</span>-<span class="title">slot</span></span></span><br><span class="line"><span class="function">1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">set</span>-<span class="title">active</span>-<span class="title">boot</span>-<span class="title">slot</span> 0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">set</span>-<span class="title">slot</span>-<span class="title">as</span>-<span class="title">unbootable</span> 1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">is</span>-<span class="title">slot</span>-<span class="title">bootable</span> 0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">is</span>-<span class="title">slot</span>-<span class="title">marked</span>-<span class="title">successful</span> 0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">suffix</span> 0</span></span><br><span class="line"><span class="function">_a</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">android</span>:/ # <span class="title">bootctl</span> <span class="title">get</span>-<span class="title">suffix</span> 1</span></span><br><span class="line"><span class="function">_b</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OTA/" rel="tag"># OTA</a>
          
            <a href="/tags/Boot/" rel="tag"># Boot</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/24/OTA/AB系统升级概述/" rel="next" title="AB 系统升级概述">
                <i class="fa fa-chevron-left"></i> AB 系统升级概述
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/08/Filesystem/MTK平台新增一个分区/" rel="prev" title="MTK 平台新增一个分区">
                MTK 平台新增一个分区 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/light_house.jpg" alt="Young">
            
              <p class="site-author-name" itemprop="name">Young</p>
              <div class="site-description motion-element" itemprop="description">自在独行</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">97</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、Bootctrl接口定义"><span class="nav-text">一、Bootctrl接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、Bootctrl的实现－Google方式"><span class="nav-text">二、Bootctrl的实现－Google方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-module-init"><span class="nav-text">2.1 module_init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-module-getNumberSlots"><span class="nav-text">2.2 module_getNumberSlots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-module-getCurrentSlot"><span class="nav-text">2.3 module_getCurrentSlot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-module-markBootSuccessful"><span class="nav-text">2.4 module_markBootSuccessful</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-module-setActiveBootSlot"><span class="nav-text">2.5 module_setActiveBootSlot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-module-setSlotAsUnbootable"><span class="nav-text">2.6 module_setSlotAsUnbootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-module-isSlotBootable"><span class="nav-text">2.7 module_isSlotBootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-module-getSuffix"><span class="nav-text">2.8 module_getSuffix</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、Bootctrl的实现－Qualcomm方式"><span class="nav-text">三、Bootctrl的实现－Qualcomm方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-boot-control-init"><span class="nav-text">3.1 boot_control_init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-get-number-slots"><span class="nav-text">3.2 get_number_slots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-get-current-slot"><span class="nav-text">3.3 get_current_slot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-mark-boot-successful"><span class="nav-text">3.4 mark_boot_successful</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-set-active-boot-slot"><span class="nav-text">3.5 set_active_boot_slot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-set-slot-as-unbootable"><span class="nav-text">3.6 set_slot_as_unbootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-is-slot-bootable"><span class="nav-text">3.7 is_slot_bootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-get-suffix"><span class="nav-text">3.8 get_suffix</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-9-is-slot-marked-successful"><span class="nav-text">3.9 is_slot_marked_successful</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、Bootctrl的实现－Mediatek方式"><span class="nav-text">四、Bootctrl的实现－Mediatek方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-bootctrl-init"><span class="nav-text">4.1 bootctrl_init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-bootctrl-get-number-slots"><span class="nav-text">4.2 bootctrl_get_number_slots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-bootctrl-get-current-slot"><span class="nav-text">4.3 bootctrl_get_current_slot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-bootctrl-mark-boot-successful"><span class="nav-text">4.4 bootctrl_mark_boot_successful</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-bootctrl-set-active-boot-slot"><span class="nav-text">4.5 bootctrl_set_active_boot_slot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-6-bootctrl-set-slot-as-unbootable"><span class="nav-text">4.6 bootctrl_set_slot_as_unbootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-7-bootctrl-is-slot-bootable"><span class="nav-text">4.7 bootctrl_is_slot_bootable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-8-bootctrl-get-bootup-status"><span class="nav-text">4.8 bootctrl_get_bootup_status</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-9-bootctrl-get-suffix"><span class="nav-text">4.9 bootctrl_get_suffix</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、Bootctrl的测试－bootctl-command"><span class="nav-text">五、Bootctrl的测试－bootctl command</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Young</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  
<style>
  .copy-btn {
    display: inline-block;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 700;
    line-height: 20px;
    color: #333;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
    
    user-select: none;
    outline: 0;
  }

  .highlight-wrap .copy-btn {
    transition: opacity .3s ease-in-out;
    opacity: 0;
    padding: 2px 6px;
    position: absolute;
    
      right: 4px;
      top: 8px;
    
  }

  .highlight-wrap:hover .copy-btn,
  .highlight-wrap .copy-btn:focus {
    opacity: 1;
  }

  .highlight-wrap {
    position: relative;
  }
</style>
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


</body>
</html>
