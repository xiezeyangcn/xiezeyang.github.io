<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="PackageManagerService是Android系统中核心服务之一，它负责系统中Package的管理，应用程序的安装、卸载、信息查询等。下面一起来分析一下它的启动过程：">
<meta name="keywords" content="Framework">
<meta property="og:type" content="article">
<meta property="og:title" content="PackageManagerService 的启动过程">
<meta property="og:url" content="http://www.xiezeyang.com/2018/06/09/Framework/PackageManagerService的启动过程/index.html">
<meta property="og:site_name" content="Young&#39;s Blog">
<meta property="og:description" content="PackageManagerService是Android系统中核心服务之一，它负责系统中Package的管理，应用程序的安装、卸载、信息查询等。下面一起来分析一下它的启动过程：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.xiezeyang.com/images/boot_packagemanagerservice.png">
<meta property="og:updated_time" content="2019-12-15T11:00:21.875Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PackageManagerService 的启动过程">
<meta name="twitter:description" content="PackageManagerService是Android系统中核心服务之一，它负责系统中Package的管理，应用程序的安装、卸载、信息查询等。下面一起来分析一下它的启动过程：">
<meta name="twitter:image" content="http://www.xiezeyang.com/images/boot_packagemanagerservice.png">






  <link rel="canonical" href="http://www.xiezeyang.com/2018/06/09/Framework/PackageManagerService的启动过程/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>PackageManagerService 的启动过程 | Young's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Young's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Personal notes</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.xiezeyang.com/2018/06/09/Framework/PackageManagerService的启动过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Young">
      <meta itemprop="description" content="自在独行">
      <meta itemprop="image" content="/images/light_house.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Young's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PackageManagerService 的启动过程

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-09 00:00:00" itemprop="dateCreated datePublished" datetime="2018-06-09T00:00:00+08:00">2018-06-09</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Framework/" itemprop="url" rel="index"><span itemprop="name">Framework</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>PackageManagerService是Android系统中核心服务之一，它负责系统中Package的管理，应用程序的安装、卸载、信息查询等。下面一起来分析一下它的启动过程：</p>
<p><img src="/images/boot_packagemanagerservice.png" alt></p>
<a id="more"></a>
<h3 id="一、SystemServer启动PackageManagerService"><a href="#一、SystemServer启动PackageManagerService" class="headerlink" title="一、SystemServer启动PackageManagerService"></a>一、SystemServer启动PackageManagerService</h3><h4 id="1-1-startBootstrapServices"><a href="#1-1-startBootstrapServices" class="headerlink" title="1.1 startBootstrapServices"></a>1.1 startBootstrapServices</h4><p>主要工作有：</p>
<p>(1)启动Installer服务；</p>
<p>(2)如果是加密设备则只解析核心应用；</p>
<p>(3)调用main方法初始化PackageManagerService；</p>
<p>(4)判断是否为首次启动；</p>
<p>(5)获取PackageManager对象；</p>
<p>(6)适用于A/B系统的dex操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/java/com/android/server/SystemServer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemServer</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 启动Installer服务</span></span><br><span class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 如果设备加密了，则只解析"core"应用</span></span><br><span class="line">        String cryptState = VoldProperties.decrypt().orElse(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</span><br><span class="line">            mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 调用PackageManagerService的main方法</span></span><br><span class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">        <span class="comment">// 判断是否是初次启动</span></span><br><span class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">        <span class="comment">// 获取packagemanager对象</span></span><br><span class="line">        mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 适用于A/B系统dex优化情况（解密时无data，所以不需要）。</span></span><br><span class="line">        <span class="comment">// 这是一个引导服务，需要它在boot之后重命名A/B工件，然后才能处理它们。</span></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">"config.disable_otadexopt"</span>,</span><br><span class="line">                    <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"starting OtaDexOptService"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-startOtherServices"><a href="#1-2-startOtherServices" class="headerlink" title="1.2 startOtherServices"></a>1.2 startOtherServices</h4><p>主要工作有：</p>
<p>(1)执行performDexOpt，完成dex优化；</p>
<p>(2)执行performFstrim，完成磁盘维护；</p>
<p>(3)调用systemReady，准备就绪。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/java/com/android/server/SystemServer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemServer</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行performDexOpt</span></span><br><span class="line">                mPackageManagerService.updatePackagesIfNeeded();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"update packages"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行磁盘维护</span></span><br><span class="line">            mPackageManagerService.performFstrimIfNeeded();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">"performing fstrim"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 准备就绪</span></span><br><span class="line">        mPackageManagerService.systemReady();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h3 id="二、PackageManagerService的初始化"><a href="#二、PackageManagerService的初始化" class="headerlink" title="二、PackageManagerService的初始化"></a>二、PackageManagerService的初始化</h3><h4 id="2-1-PackageManagerService的main方法"><a href="#2-1-PackageManagerService的main方法" class="headerlink" title="2.1 PackageManagerService的main方法"></a>2.1 PackageManagerService的main方法</h4><p>主要工作有：</p>
<p>(1)检查Package编译相关系统属性；</p>
<p>(2)调用PackageManagerService构造方法；</p>
<p>(3)启用部分应用服务于多用户场景；</p>
<p>(4)往ServiceManager中注册”package”和”package_native”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 检查编译相关属性</span></span><br><span class="line">        PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line">        <span class="comment">// 调用构造方法，创建PackageManagerService实例</span></span><br><span class="line">        PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">                factoryTest, onlyCore);</span><br><span class="line">        <span class="comment">// 多用户场景下启动部分package</span></span><br><span class="line">        m.enableSystemUserPackages();</span><br><span class="line">        <span class="comment">// 向ServiceManager注册package和package_native</span></span><br><span class="line">        ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">        <span class="keyword">final</span> PackageManagerNative pmn = m.new PackageManagerNative();</span><br><span class="line">        ServiceManager.addService(<span class="string">"package_native"</span>, pmn);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-PackageManagerService的构造方法"><a href="#2-2-PackageManagerService的构造方法" class="headerlink" title="2.2 PackageManagerService的构造方法"></a>2.2 PackageManagerService的构造方法</h4><h5 id="2-2-1-BOOT-PROGRESS-PMS-START阶段"><a href="#2-2-1-BOOT-PROGRESS-PMS-START阶段" class="headerlink" title="2.2.1 BOOT_PROGRESS_PMS_START阶段"></a>2.2.1 BOOT_PROGRESS_PMS_START阶段</h5><p>主要工作有：</p>
<p>(1)构造DisplayMetrics，保存分辨率等相关信息；</p>
<p>(2)创建Installer对象，与installd交互；</p>
<p>(3)创建mPermissionManager对象，进行权限管理；</p>
<p>(4)构造Settings类，保存安装包信息，清除路径不存在的孤立应用，主要涉及/data/system/目录的packages.xml，packages-backup.xml，packages.list，packages-stopped.xml，packages-stopped-backup.xml等文件。</p>
<p>(5)构造PackageDexOptimizer及DexManager类，处理dex优化；</p>
<p>(6)创建SystemConfig实例，获取系统配置信息，配置共享lib库；</p>
<p>(7)创建PackageManager的handler线程，循环处理外部安装相关消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line">        <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mContext = context;</span><br><span class="line">        <span class="comment">// 一般为false，即非工厂模式</span></span><br><span class="line">        mFactoryTest = factoryTest;</span><br><span class="line">        <span class="comment">// 一般为false，因出货软件必须开启加密</span></span><br><span class="line">        mOnlyCore = onlyCore;</span><br><span class="line">        <span class="comment">// 分辨率配置</span></span><br><span class="line">        mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">        <span class="comment">// 创建mInstaller对象，将于installd交互</span></span><br><span class="line">        mInstaller = installer;</span><br><span class="line">        <span class="comment">// 创建提供服务、数据的重要子组件。</span></span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="comment">// 公开系统组件使用的私有服务</span></span><br><span class="line">                <span class="comment">// 本地服务</span></span><br><span class="line">                LocalServices.addService(</span><br><span class="line">                        PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br><span class="line">                <span class="comment">// 多用户管理服务</span></span><br><span class="line">                sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>,</span><br><span class="line">                        <span class="keyword">new</span> UserDataPreparer(mInstaller, mInstallLock, mContext, mOnlyCore), mPackages);</span><br><span class="line">                <span class="comment">// 权限管理服务</span></span><br><span class="line">                mPermissionManager = PermissionManagerService.create(context,</span><br><span class="line">                        <span class="keyword">new</span> DefaultPermissionGrantedCallback() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDefaultRuntimePermissionsGranted</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">synchronized</span>(mPackages) &#123;</span><br><span class="line">                                    mSettings.onDefaultRuntimePermissionsGrantedLPr(userId);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, mPackages <span class="comment">/*externalLock*/</span>);</span><br><span class="line">                mDefaultPermissionPolicy = mPermissionManager.getDefaultPermissionGrantPolicy();</span><br><span class="line">                mSettings = <span class="keyword">new</span> Settings(mPermissionManager.getPermissionSettings(), mPackages);</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        <span class="comment">// 添加system, phone, log, nfc, bluetooth, shell, se, networkstack等特权共享uid信息</span></span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.se"</span>, SE_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        mSettings.addSharedUserLPw(<span class="string">"android.uid.networkstack"</span>, NETWORKSTACK_UID,</span><br><span class="line">                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">        <span class="comment">// 进程分离相关调试，即设置了该属性，则强制应用在自己的进程中运行</span></span><br><span class="line">        String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</span><br><span class="line">        <span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</span><br><span class="line">                mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">                mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">                mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></span><br><span class="line">                        + separateProcesses);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">            mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// DexOpt优化</span></span><br><span class="line">        mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">                <span class="string">"*dexopt*"</span>);</span><br><span class="line">        DexManager.Listener dexManagerListener = DexLogger.getListener(<span class="keyword">this</span>,</span><br><span class="line">                installer, mInstallLock);</span><br><span class="line">        mDexManager = <span class="keyword">new</span> DexManager(mContext, <span class="keyword">this</span>, mPackageDexOptimizer, installer, mInstallLock,</span><br><span class="line">                dexManagerListener);</span><br><span class="line">        <span class="comment">// ART虚拟机管理服务</span></span><br><span class="line">        mArtManagerService = <span class="keyword">new</span> ArtManagerService(mContext, <span class="keyword">this</span>, installer, mInstallLock);</span><br><span class="line">        <span class="comment">// 回调方法</span></span><br><span class="line">        mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line">        <span class="comment">// 权限变化监听器</span></span><br><span class="line">        mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">                FgThread.get().getLooper());</span><br><span class="line">        <span class="comment">// 获取默认分辨率</span></span><br><span class="line">        getDefaultDisplayMetrics(context, mMetrics);</span><br><span class="line">        <span class="comment">// 获取系统配置systemConfig</span></span><br><span class="line">        SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line">        mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line">        mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="comment">// 启动"PackageManager"线程，负责apk的安装、卸载</span></span><br><span class="line">                mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">                        Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">                mHandlerThread.start();</span><br><span class="line">                <span class="comment">// 应用handler</span></span><br><span class="line">                mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">                <span class="comment">// 进程记录handler</span></span><br><span class="line">                mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">                <span class="comment">// Watchdog监听ServiceThread是否超时：10分钟</span></span><br><span class="line">                Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line">                <span class="comment">// Instant应用注册</span></span><br><span class="line">                mInstantAppRegistry = <span class="keyword">new</span> InstantAppRegistry(<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// 共享lib库配置</span></span><br><span class="line">                ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> builtInLibCount = libConfig.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; builtInLibCount; i++) &#123;</span><br><span class="line">                    String name = libConfig.keyAt(i);</span><br><span class="line">                    String path = libConfig.valueAt(i);</span><br><span class="line">                    addSharedLibraryLPw(path, <span class="keyword">null</span>, <span class="keyword">null</span>, name, SharedLibraryInfo.VERSION_UNDEFINED,</span><br><span class="line">                            SharedLibraryInfo.TYPE_BUILTIN, PLATFORM_PACKAGE_NAME, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 内置库依赖性处理</span></span><br><span class="line">                setupBuiltinSharedLibraryDependenciesLocked();</span><br><span class="line">                <span class="comment">// 读取安装相关SELinux策略</span></span><br><span class="line">                SELinuxMMAC.readInstallPolicy();</span><br><span class="line">                <span class="comment">// 返回栈加载</span></span><br><span class="line">                FallbackCategoryProvider.loadFallbacks();</span><br><span class="line">                mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br><span class="line">                <span class="comment">// 清理代码路径不存在的孤立软件包</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                            &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mSettings.mPackages.removeAt(i);</span><br><span class="line">                        mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果不是首次启动，也不是CORE应用，则拷贝预编译的DEX文件</span></span><br><span class="line">                <span class="keyword">if</span> (!mOnlyCore &amp;&amp; mFirstBoot) &#123;</span><br><span class="line">                    requestCopyPreoptedFiles();</span><br><span class="line">                &#125;</span><br><span class="line">                String customResolverActivity = Resources.getSystem().getString(</span><br><span class="line">                        R.string.config_customResolverActivity);</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(customResolverActivity)) &#123;</span><br><span class="line">                    customResolverActivity = <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mCustomResolverComponentName = ComponentName.unflattenFromString(</span><br><span class="line">                            customResolverActivity);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START阶段"><a href="#2-2-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START阶段" class="headerlink" title="2.2.2 BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段"></a>2.2.2 BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段</h5><p>主要工作有：</p>
<p>(1)从init.rc中获取环境变量BOOTCLASSPATH和SYSTEMSERVERCLASSPATH；</p>
<p>(2)对于旧版本升级的情况，将安装时获取权限变更为运行时申请权限；</p>
<p>(3)扫描system/vendor/product/odm/oem等目录的priv-app、app、overlay包；</p>
<p>(4)清除安装时临时文件以及其他不必要的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">// 记录扫描开始时间</span></span><br><span class="line">                <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">                        startTime);</span><br><span class="line">                <span class="comment">// 从init.r中获取环境变量</span></span><br><span class="line">                <span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line">                <span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">                <span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// system/framework目录</span></span><br><span class="line">                File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line">                <span class="comment">// 获取内部版本👌</span></span><br><span class="line">                <span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line">                <span class="comment">// 判断fingerprint是否有更新</span></span><br><span class="line">                mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line">                <span class="keyword">if</span> (mIsUpgrade) &#123;</span><br><span class="line">                    logCriticalInfo(Log.INFO,</span><br><span class="line">                            <span class="string">"Upgrading from "</span> + ver.fingerprint + <span class="string">" to "</span> + Build.FINGERPRINT);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 对于Android M之前版本升级上来的情况，需将系统应用程序权限从安装升级到运行时</span></span><br><span class="line">                mPromoteSystemApps =</span><br><span class="line">                        mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line">                <span class="comment">// 对于Android N之前版本升级上来的情况，需像首次启动一样处理package</span></span><br><span class="line">                mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line">                mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line">                <span class="comment">// 在扫描之前保存预先存在的系统package的名称，不希望自动为新系统应用授予运行时权限</span></span><br><span class="line">                <span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">                    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">                        PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">                        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">                            mExistingSystemPackages.add(ps.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 准备解析package的缓存</span></span><br><span class="line">                mCacheDir = preparePackageParserCache(mIsUpgrade);</span><br><span class="line">                <span class="comment">// 设置flag，而不在扫描安装时更改文件路径</span></span><br><span class="line">                <span class="keyword">int</span> scanFlags = SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line">                <span class="keyword">if</span> (mIsUpgrade || mFirstBoot) &#123;</span><br><span class="line">                    scanFlags = scanFlags | SCAN_FIRST_BOOT_OR_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 扫描vendor/overlay包</span></span><br><span class="line">                scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR),</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_VENDOR,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描product/overlay包</span></span><br><span class="line">                scanDirTracedLI(<span class="keyword">new</span> File(PRODUCT_OVERLAY_DIR),</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_PRODUCT,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                mParallelPackageParserCallback.findStaticOverlayPackages();</span><br><span class="line">                <span class="comment">// 扫描system/framework不包含源码的资源包</span></span><br><span class="line">                scanDirTracedLI(frameworkDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_NO_DEX</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_PRIVILEGED,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描system/priv-app包</span></span><br><span class="line">                <span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">                scanDirTracedLI(privilegedAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_PRIVILEGED,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 扫描system/apps包</span></span><br><span class="line">                <span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">                scanDirTracedLI(systemAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 扫描vendor/priv-app包</span></span><br><span class="line">                File privilegedVendorAppDir = <span class="keyword">new</span> File(Environment.getVendorDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    privilegedVendorAppDir = privilegedVendorAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(privilegedVendorAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_VENDOR</span><br><span class="line">                        | SCAN_AS_PRIVILEGED,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描vendor/app包</span></span><br><span class="line">                File vendorAppDir = <span class="keyword">new</span> File(Environment.getVendorDirectory(), <span class="string">"app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(vendorAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_VENDOR,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描odm/priv-app包</span></span><br><span class="line">                File privilegedOdmAppDir = <span class="keyword">new</span> File(Environment.getOdmDirectory(),</span><br><span class="line">                            <span class="string">"priv-app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    privilegedOdmAppDir = privilegedOdmAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(privilegedOdmAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_VENDOR</span><br><span class="line">                        | SCAN_AS_PRIVILEGED,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描odm/app包</span></span><br><span class="line">                File odmAppDir = <span class="keyword">new</span> File(Environment.getOdmDirectory(), <span class="string">"app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    odmAppDir = odmAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(odmAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_VENDOR,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描oem/app包</span></span><br><span class="line">                <span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">                scanDirTracedLI(oemAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_OEM,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描product/priv-app包</span></span><br><span class="line">                File privilegedProductAppDir = <span class="keyword">new</span> File(Environment.getProductDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    privilegedProductAppDir = privilegedProductAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(privilegedProductAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_PRODUCT</span><br><span class="line">                        | SCAN_AS_PRIVILEGED,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 扫描product/app包</span></span><br><span class="line">                File productAppDir = <span class="keyword">new</span> File(Environment.getProductDirectory(), <span class="string">"app"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    productAppDir = productAppDir.getCanonicalFile();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">                &#125;</span><br><span class="line">                scanDirTracedLI(productAppDir,</span><br><span class="line">                        mDefParseFlags</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">                        scanFlags</span><br><span class="line">                        | SCAN_AS_SYSTEM</span><br><span class="line">                        | SCAN_AS_PRODUCT,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 删掉不存在的package</span></span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; stubSystemApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Iterator&lt;PackageParser.Package&gt; pkgIterator = mPackages.values().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (pkgIterator.hasNext()) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageParser.Package pkg = pkgIterator.next();</span><br><span class="line">                        <span class="keyword">if</span> (pkg.isStub) &#123;</span><br><span class="line">                            stubSystemApps.add(pkg.packageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">                        PackageSetting ps = psit.next();</span><br><span class="line">                        <span class="comment">// 如果不是系统应用，则不被允许disable</span></span><br><span class="line">                        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果应用被扫描，则不允许被擦除</span></span><br><span class="line">                        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">                        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 如果系统应用被扫描且存在disable应用列表中，则只能通过OTA升级添加</span></span><br><span class="line">                            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                                logCriticalInfo(Log.WARN,</span><br><span class="line">                                        <span class="string">"Expecting better updated system app for "</span> + ps.name</span><br><span class="line">                                        + <span class="string">"; removing system app.  Last known"</span></span><br><span class="line">                                        + <span class="string">" codePath="</span> + ps.codePathString</span><br><span class="line">                                        + <span class="string">", versionCode="</span> + ps.versionCode</span><br><span class="line">                                        + <span class="string">"; scanned versionCode="</span> + scannedPkg.getLongVersionCode());</span><br><span class="line">                                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                            psit.remove();</span><br><span class="line">                            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> PackageSetting disabledPs =</span><br><span class="line">                                    mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">                            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()</span><br><span class="line">                                    || disabledPs.pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 删除临时文件</span></span><br><span class="line">                deleteTempPackageFiles();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> cachedSystemApps = PackageParser.sCachedPackageReadCount.get();</span><br><span class="line">                <span class="comment">// 删除没有关联应用的共享UID标识</span></span><br><span class="line">                mSettings.pruneSharedUsersLPw();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> systemScanTime = SystemClock.uptimeMillis() - startTime;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> systemPackagesCount = mPackages.size();</span><br><span class="line">                Slog.i(TAG, <span class="string">"Finished scanning system apps. Time: "</span> + systemScanTime</span><br><span class="line">                        + <span class="string">" ms, packageCount: "</span> + systemPackagesCount</span><br><span class="line">                        + <span class="string">" , timePerPackage: "</span></span><br><span class="line">                        + (systemPackagesCount == <span class="number">0</span> ? <span class="number">0</span> : systemScanTime / systemPackagesCount)</span><br><span class="line">                        + <span class="string">" , cached: "</span> + cachedSystemApps);</span><br><span class="line">                <span class="keyword">if</span> (mIsUpgrade &amp;&amp; systemPackagesCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"ota_package_manager_system_app_avg_scan_time"</span>,</span><br><span class="line">                            ((<span class="keyword">int</span>) systemScanTime) / systemPackagesCount);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-BOOT-PROGRESS-PMS-DATA-SCAN-START阶段"><a href="#2-2-3-BOOT-PROGRESS-PMS-DATA-SCAN-START阶段" class="headerlink" title="2.2.3 BOOT_PROGRESS_PMS_DATA_SCAN_START阶段"></a>2.2.3 BOOT_PROGRESS_PMS_DATA_SCAN_START阶段</h5><p>主要工作有：对于不仅仅解析核心应用的情况下，还处理data目录的应用信息，及时更新，祛除不必要的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                            SystemClock.uptimeMillis());</span><br><span class="line">                    scanDirTracedLI(sAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">                    scanDirTracedLI(sDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">                            | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">                            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">                    <span class="comment">// 移除通过OTA删除的更新系统应用程序的禁用package设置</span></span><br><span class="line">                    <span class="comment">// 如果更新不再存在，则完全删除该应用。否则，撤消其系统权限</span></span><br><span class="line">                    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">                        PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">                        mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line">                        <span class="keyword">final</span> String msg;</span><br><span class="line">                        <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">                                    + <span class="string">" no longer exists; removing its data"</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            msg = <span class="string">"Updated system package + "</span> + deletedAppName</span><br><span class="line">                                    + <span class="string">" no longer exists; revoking system privileges"</span>;</span><br><span class="line">                            <span class="keyword">final</span> PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">                            deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">                            deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">                        &#125;</span><br><span class="line">                        logCriticalInfo(Log.WARN, msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 确保期望在userdata分区上显示的所有系统应用程序实际显示</span></span><br><span class="line">                    <span class="comment">// 如果从未出现过，需要回滚以恢复系统版本</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">                        <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">                            <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line">                            logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                                    + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line">                            <span class="keyword">final</span> <span class="meta">@ParseFlags</span> <span class="keyword">int</span> reparseFlags;</span><br><span class="line">                            <span class="keyword">final</span> <span class="meta">@ScanFlags</span> <span class="keyword">int</span> rescanFlags;</span><br><span class="line">                            <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_PRIVILEGED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(privilegedVendorAppDir, scanFile)</span><br><span class="line">                                    || FileUtils.contains(privilegedOdmAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_VENDOR</span><br><span class="line">                                        | SCAN_AS_PRIVILEGED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)</span><br><span class="line">                                    || FileUtils.contains(odmAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_VENDOR;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_OEM;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(privilegedProductAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_PRODUCT</span><br><span class="line">                                        | SCAN_AS_PRIVILEGED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(productAppDir, scanFile)) &#123;</span><br><span class="line">                                reparseFlags =</span><br><span class="line">                                        mDefParseFlags |</span><br><span class="line">                                        PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                                rescanFlags =</span><br><span class="line">                                        scanFlags</span><br><span class="line">                                        | SCAN_AS_SYSTEM</span><br><span class="line">                                        | SCAN_AS_PRODUCT;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                scanPackageTracedLI(scanFile, reparseFlags, rescanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                                Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                                        + e.getMessage());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 解压缩并安装任何存根系统应用程序。必须最后执行此操作以确保替换或禁用所有存根</span></span><br><span class="line">                    decompressSystemApplications(stubSystemApps, scanFlags);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> cachedNonSystemApps = PackageParser.sCachedPackageReadCount.get()</span><br><span class="line">                                    - cachedSystemApps;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> dataScanTime = SystemClock.uptimeMillis() - systemScanTime - startTime;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> dataPackagesCount = mPackages.size() - systemPackagesCount;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Finished scanning non-system apps. Time: "</span> + dataScanTime</span><br><span class="line">                            + <span class="string">" ms, packageCount: "</span> + dataPackagesCount</span><br><span class="line">                            + <span class="string">" , timePerPackage: "</span></span><br><span class="line">                            + (dataPackagesCount == <span class="number">0</span> ? <span class="number">0</span> : dataScanTime / dataPackagesCount)</span><br><span class="line">                            + <span class="string">" , cached: "</span> + cachedNonSystemApps);</span><br><span class="line">                    <span class="keyword">if</span> (mIsUpgrade &amp;&amp; dataPackagesCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"ota_package_manager_data_app_avg_scan_time"</span>,</span><br><span class="line">                                ((<span class="keyword">int</span>) dataScanTime) / dataPackagesCount);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mExpectingBetter.clear();</span><br><span class="line">                <span class="comment">// 获取storage manager包名</span></span><br><span class="line">                mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line">                <span class="comment">// 解决受保护的action过滤器。只允许setup wizard为这些action设置高优先级过滤器</span></span><br><span class="line">                mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line">                <span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"No setup wizard;"</span></span><br><span class="line">                            + <span class="string">" All protected intents capped to priority 0"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                                Slog.i(TAG, <span class="string">"Found setup wizard;"</span></span><br><span class="line">                                    + <span class="string">" allow priority "</span> + filter.getPriority() + <span class="string">";"</span></span><br><span class="line">                                    + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                                    + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                                    + <span class="string">" priority: "</span> + filter.getPriority());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                            Slog.i(TAG, <span class="string">"Protected action; cap priority to 0;"</span></span><br><span class="line">                                    + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                                    + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                                    + <span class="string">" origPrio: "</span> + filter.getPriority());</span><br><span class="line">                        &#125;</span><br><span class="line">                        filter.setPriority(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mSystemTextClassifierPackage = getSystemTextClassifierPackageName();</span><br><span class="line">                mDeferProtectedFilters = <span class="keyword">false</span>;</span><br><span class="line">                mProtectedFilters.clear();</span><br><span class="line">                <span class="comment">// 更新客户端以确保持有正确的共享库路径</span></span><br><span class="line">                updateAllSharedLibrariesLPw(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> List&lt;String&gt; changedAbiCodePath =</span><br><span class="line">                            adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/*scannedPackage*/</span>);</span><br><span class="line">                    <span class="keyword">if</span> (changedAbiCodePath != <span class="keyword">null</span> &amp;&amp; changedAbiCodePath.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = changedAbiCodePath.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                            <span class="keyword">final</span> String codePathString = changedAbiCodePath.get(i);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                mInstaller.rmdex(codePathString,</span><br><span class="line">                                        getDexCodeInstructionSet(getPreferredInstructionSet()));</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InstallerException ignored) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 调整seInfo以确保共享sharedUserId的应用程序位于同一SELinux域中</span></span><br><span class="line">                    setting.fixSeInfoLocked();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 读取并更新要保留的package的上次使用时间</span></span><br><span class="line">                mPackageUsage.read(mPackages);</span><br><span class="line">                mCompilerStats.read();</span><br><span class="line">                ...</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-4-BOOT-PROGRESS-PMS-SCAN-END阶段"><a href="#2-2-4-BOOT-PROGRESS-PMS-SCAN-END阶段" class="headerlink" title="2.2.4 BOOT_PROGRESS_PMS_SCAN_END阶段"></a>2.2.4 BOOT_PROGRESS_PMS_SCAN_END阶段</h5><p>主要工作有：</p>
<p>(1)sdk版本变更，更新权限；</p>
<p>(2)OTA升级后首次启动，清除不必要的缓存数据；</p>
<p>(3)权限等默认项更新完后，清理相关数据；</p>
<p>(4)更新package.xml。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                ...</span><br><span class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                Slog.i(TAG, <span class="string">"Time to scan packages: "</span></span><br><span class="line">                        + ((SystemClock.uptimeMillis()-startTime)/<span class="number">1000f</span>)</span><br><span class="line">                        + <span class="string">" seconds"</span>);</span><br><span class="line">                <span class="comment">// 如果自上次启动以来，平台SDK已改变，则需要重新授予应用程序权限以捕获出现的任何新权限</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> sdkUpdated = (ver.sdkVersion != mSdkVersion);</span><br><span class="line">                <span class="keyword">if</span> (sdkUpdated) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">                            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mPermissionManager.updateAllPermissions(</span><br><span class="line">                        StorageManager.UUID_PRIVATE_INTERNAL, sdkUpdated, mPackages.values(),</span><br><span class="line">                        mPermissionCallback);</span><br><span class="line">                ver.sdkVersion = mSdkVersion;</span><br><span class="line">                <span class="comment">// 如果这是第一次启动或来自Android M之前的版本的升级，并且它是正常启动，那需要在所有已定义的用户中初始化默认的首选应用程序</span></span><br><span class="line">                <span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                        mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">                        applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">                        primeDomainVerificationsLPw(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 在启动期间确实为系统用户准备存储，因为像SettingsProvider和SystemUI这样的核心系统应用程序无法等待用户启动</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line">                <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">                    storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;String&gt; deferPackages = reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                        UserHandle.USER_SYSTEM, storageFlags, <span class="keyword">true</span> <span class="comment">/* migrateAppData */</span>,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* onlyCoreApps */</span>);</span><br><span class="line">                mPrepareAppDataFuture = SystemServerInitThreadPool.get().submit(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mInstaller.fixupAppData(StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Trouble fixing GIDs"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (deferPackages == <span class="keyword">null</span> || deferPackages.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span> (String pkgName : deferPackages) &#123;</span><br><span class="line">                        PackageParser.Package pkg = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                            PackageSetting ps = mSettings.getPackageLPr(pkgName);</span><br><span class="line">                            <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.getInstalled(UserHandle.USER_SYSTEM)) &#123;</span><br><span class="line">                                pkg = ps.pkg;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                                prepareAppDataAndMigrateLIF(pkg, UserHandle.USER_SYSTEM, storageFlags,</span><br><span class="line">                                        <span class="keyword">true</span> <span class="comment">/* maybeMigrateAppData */</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            count++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Deferred reconcileAppsData finished "</span> + count + <span class="string">" packages"</span>);</span><br><span class="line">                &#125;, <span class="string">"prepareAppData"</span>);</span><br><span class="line">                <span class="comment">// 如果是在OTA之后首次启动，并且正常启动，那需要清除代码缓存目录，但不清除应用程序配置文件</span></span><br><span class="line">                <span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                        <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">                            clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                                            | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 检查默认浏览器</span></span><br><span class="line">                checkDefaultBrowser();</span><br><span class="line">                <span class="comment">// 仅在权限或其它默认配置更新后清除</span></span><br><span class="line">                mExistingSystemPackages.clear();</span><br><span class="line">                mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 所有变更均在扫描过程中完成</span></span><br><span class="line">                ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line">                <span class="comment">// 降级读取</span></span><br><span class="line">                mSettings.writeLPr();</span><br><span class="line">                ...</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-5-BOOT-PROGRESS-PMS-READY阶段"><a href="#2-2-5-BOOT-PROGRESS-PMS-READY阶段" class="headerlink" title="2.2.5 BOOT_PROGRESS_PMS_READY阶段"></a>2.2.5 BOOT_PROGRESS_PMS_READY阶段</h5><p>主要工作有：</p>
<p>(1)创建PackageInstallerService对象；</p>
<p>(2)GC回收内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">PackageSender</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// mInstallLock锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">// mPackages锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                ...</span><br><span class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                    mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">                    mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">                    mRequiredUninstallerPackage = getRequiredUninstallerLPr();</span><br><span class="line">                    mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">                    <span class="keyword">if</span> (mIntentFilterVerifierComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                                mIntentFilterVerifierComponent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                            PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES,</span><br><span class="line">                            SharedLibraryInfo.VERSION_UNDEFINED);</span><br><span class="line">                    mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                            PackageManager.SYSTEM_SHARED_LIBRARY_SHARED,</span><br><span class="line">                            SharedLibraryInfo.VERSION_UNDEFINED);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">                    mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">                    mRequiredUninstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">                    mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">                    mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">                    mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">                    mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">final</span> Pair&lt;ComponentName, String&gt; instantAppResolverComponent =</span><br><span class="line">                        getInstantAppResolverLPr();</span><br><span class="line">                <span class="keyword">if</span> (instantAppResolverComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTANT) &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"Set ephemeral resolver: "</span> + instantAppResolverComponent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mInstantAppResolverConnection = <span class="keyword">new</span> InstantAppResolverConnection(</span><br><span class="line">                            mContext, instantAppResolverComponent.first,</span><br><span class="line">                            instantAppResolverComponent.second);</span><br><span class="line">                    mInstantAppResolverSettingsComponent =</span><br><span class="line">                            getInstantAppResolverSettingsLPr(instantAppResolverComponent.first);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstantAppResolverConnection = <span class="keyword">null</span>;</span><br><span class="line">                    mInstantAppResolverSettingsComponent = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                updateInstantAppInstallerLocked(<span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// 阅读并更新dex文件的用法</span></span><br><span class="line">                <span class="comment">// 在PM init结束时执行此操作，以便所有程序包都已协调其数据目录</span></span><br><span class="line">                <span class="comment">// 此时知道了包的代码路径，因此可以验证磁盘文件并构建内部缓存</span></span><br><span class="line">                <span class="comment">// 使用文件预计很小，因此与其他活动（例如包扫描）相比，加载和验证它应该花费相当小的时间</span></span><br><span class="line">                <span class="keyword">final</span> Map&lt;Integer, List&lt;PackageInfo&gt;&gt; userPackages = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] currentUserIds = UserManagerService.getInstance().getUserIds();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> userId : currentUserIds) &#123;</span><br><span class="line">                    userPackages.put(userId, getInstalledPackages(<span class="comment">/*flags*/</span> <span class="number">0</span>, userId).getList());</span><br><span class="line">                &#125;</span><br><span class="line">                mDexManager.load(userPackages);</span><br><span class="line">                <span class="keyword">if</span> (mIsUpgrade) &#123;</span><br><span class="line">                    MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"ota_package_manager_init_time"</span>,</span><br><span class="line">                            (<span class="keyword">int</span>) (SystemClock.uptimeMillis() - startTime));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="comment">// mPackages</span></span><br><span class="line">        &#125;<span class="comment">// mInstallLock</span></span><br><span class="line">        <span class="comment">// 打开应用之后，及时回收处理</span></span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line">        <span class="comment">// 上面的初始扫描在持有mPackage锁的同时对installd进行了多次调用</span></span><br><span class="line">        mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Framework/" rel="tag"># Framework</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/02/Power/状态栏的电池图标定制/" rel="next" title="状态栏的电池图标定制">
                <i class="fa fa-chevron-left"></i> 状态栏的电池图标定制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/16/Framework/不同应用安装场景流程剖析/" rel="prev" title="不同应用安装场景流程剖析">
                不同应用安装场景流程剖析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/light_house.jpg" alt="Young">
            
              <p class="site-author-name" itemprop="name">Young</p>
              <div class="site-description motion-element" itemprop="description">自在独行</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">104</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、SystemServer启动PackageManagerService"><span class="nav-text">一、SystemServer启动PackageManagerService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-startBootstrapServices"><span class="nav-text">1.1 startBootstrapServices</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-startOtherServices"><span class="nav-text">1.2 startOtherServices</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、PackageManagerService的初始化"><span class="nav-text">二、PackageManagerService的初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-PackageManagerService的main方法"><span class="nav-text">2.1 PackageManagerService的main方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-PackageManagerService的构造方法"><span class="nav-text">2.2 PackageManagerService的构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-BOOT-PROGRESS-PMS-START阶段"><span class="nav-text">2.2.1 BOOT_PROGRESS_PMS_START阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START阶段"><span class="nav-text">2.2.2 BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-BOOT-PROGRESS-PMS-DATA-SCAN-START阶段"><span class="nav-text">2.2.3 BOOT_PROGRESS_PMS_DATA_SCAN_START阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-4-BOOT-PROGRESS-PMS-SCAN-END阶段"><span class="nav-text">2.2.4 BOOT_PROGRESS_PMS_SCAN_END阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-5-BOOT-PROGRESS-PMS-READY阶段"><span class="nav-text">2.2.5 BOOT_PROGRESS_PMS_READY阶段</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Young</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  
<style>
  .copy-btn {
    display: inline-block;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 700;
    line-height: 20px;
    color: #333;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
    
    user-select: none;
    outline: 0;
  }

  .highlight-wrap .copy-btn {
    transition: opacity .3s ease-in-out;
    opacity: 0;
    padding: 2px 6px;
    position: absolute;
    
      right: 4px;
      top: 8px;
    
  }

  .highlight-wrap:hover .copy-btn,
  .highlight-wrap .copy-btn:focus {
    opacity: 1;
  }

  .highlight-wrap {
    position: relative;
  }
</style>
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


</body>
</html>
