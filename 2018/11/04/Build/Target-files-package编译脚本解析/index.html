<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="1.1 编译target files依赖的目标首先列出编译target-files依赖的目标。如boot/system/vendor等image，imgdifff/bsdiff/releasetool等编译OTA包的工具。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484">
<meta name="keywords" content="Build,Makefile,OTA">
<meta property="og:type" content="article">
<meta property="og:title" content="Target files package 编译脚本解析">
<meta property="og:url" content="http://www.xiezeyang.com/2018/11/04/Build/Target-files-package编译脚本解析/index.html">
<meta property="og:site_name" content="Young&#39;s Blog">
<meta property="og:description" content="1.1 编译target files依赖的目标首先列出编译target-files依赖的目标。如boot/system/vendor等image，imgdifff/bsdiff/releasetool等编译OTA包的工具。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-12-15T10:52:00.425Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Target files package 编译脚本解析">
<meta name="twitter:description" content="1.1 编译target files依赖的目标首先列出编译target-files依赖的目标。如boot/system/vendor等image，imgdifff/bsdiff/releasetool等编译OTA包的工具。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484">






  <link rel="canonical" href="http://www.xiezeyang.com/2018/11/04/Build/Target-files-package编译脚本解析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Target files package 编译脚本解析 | Young's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Young's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Personal notes</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.xiezeyang.com/2018/11/04/Build/Target-files-package编译脚本解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Young">
      <meta itemprop="description" content="自在独行">
      <meta itemprop="image" content="/images/light_house.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Young's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Target files package 编译脚本解析

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-04 00:00:00" itemprop="dateCreated datePublished" datetime="2018-11-04T00:00:00+08:00">2018-11-04</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Build/" itemprop="url" rel="index"><span itemprop="name">Build</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="1-1-编译target-files依赖的目标"><a href="#1-1-编译target-files依赖的目标" class="headerlink" title="1.1 编译target files依赖的目标"></a>1.1 编译target files依赖的目标</h4><p>首先列出编译target-files依赖的目标。如boot/system/vendor等image，imgdifff/bsdiff/releasetool等编译OTA包的工具。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(BUILT_TARGET_FILES_PACKAGE)</span>: \</span><br><span class="line">        <span class="comment"># boot image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_BOOTIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># radio image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_RADIOIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># recovery image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_RECOVERYIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># system/user image依赖的文件</span></span><br><span class="line">        <span class="variable">$(FULL_SYSTEMIMAGE_DEPS)</span> \</span><br><span class="line">        <span class="comment"># userdata image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_USERDATAIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># cache image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_CACHEIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># vendor image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_VENDORIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># product image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_PRODUCTIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># vbmeta image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_VBMETAIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># dtbo image相关目标</span></span><br><span class="line">        <span class="variable">$(INSTALLED_DTBOIMAGE_TARGET)</span> \</span><br><span class="line">        <span class="comment"># system image相关目标</span></span><br><span class="line">        <span class="variable">$(INTERNAL_SYSTEMOTHERIMAGE_FILES)</span> \</span><br><span class="line">        <span class="comment"># android-info.txt</span></span><br><span class="line">        <span class="variable">$(INSTALLED_ANDROID_INFO_TXT_TARGET)</span> \</span><br><span class="line">        <span class="comment"># kernel文件</span></span><br><span class="line">        <span class="variable">$(INSTALLED_KERNEL_TARGET)</span> \</span><br><span class="line">        <span class="comment"># 2ndbootloader文件</span></span><br><span class="line">        <span class="variable">$(INSTALLED_2NDBOOTLOADER_TARGET)</span> \</span><br><span class="line">        <span class="comment"># system base fs</span></span><br><span class="line">        $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_SYSTEM_BASE_FS_PATH) \</span><br><span class="line">        <span class="comment"># vendor base fs</span></span><br><span class="line">        $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_VENDOR_BASE_FS_PATH) \</span><br><span class="line">        <span class="comment"># product base fs</span></span><br><span class="line">        $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_PRODUCT_BASE_FS_PATH) \</span><br><span class="line">        <span class="comment"># selinux目录file_contexts.bin</span></span><br><span class="line">        <span class="variable">$(SELINUX_FC)</span> \</span><br><span class="line">        <span class="comment"># apkcerts.txt</span></span><br><span class="line">        <span class="variable">$(APKCERTS_FILE)</span> \</span><br><span class="line">        <span class="comment"># soong_zip文件</span></span><br><span class="line">        <span class="variable">$(SOONG_ZIP)</span> \</span><br><span class="line">        <span class="comment"># fs_config工具</span></span><br><span class="line">        <span class="variable">$(HOST_OUT_EXECUTABLES)</span>/fs_config \</span><br><span class="line">        <span class="comment"># imgdiff工具</span></span><br><span class="line">        <span class="variable">$(HOST_OUT_EXECUTABLES)</span>/imgdiff \</span><br><span class="line">        <span class="comment"># bsdiff工具</span></span><br><span class="line">        <span class="variable">$(HOST_OUT_EXECUTABLES)</span>/bsdiff \</span><br><span class="line">        <span class="comment"># build/make/tools/releasetools目录*.py脚本</span></span><br><span class="line">        <span class="variable">$(BUILD_IMAGE_SRCS)</span> \</span><br><span class="line">        <span class="comment"># vendor_manifest.xml</span></span><br><span class="line">        <span class="variable">$(BUILT_VENDOR_MANIFEST)</span> \</span><br><span class="line">        <span class="comment"># vendor_matrix.xml</span></span><br><span class="line">        <span class="variable">$(BUILT_VENDOR_MATRIX)</span> \</span><br><span class="line">        | <span class="variable">$(ACP)</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="1-2-创建target-files目录"><a href="#1-2-创建target-files目录" class="headerlink" title="1.2 创建target files目录"></a>1.2 创建target files目录</h4><p>将上述依赖的目标列入target-files list，创建target-files目录，为后续打包作准备。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@echo <span class="string">"Package target files: <span class="variable">$@</span>"</span></span><br><span class="line"><span class="comment"># system/vendor -&gt; vendor链接</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create-system-vendor-symlink)</span></span><br><span class="line"><span class="comment"># system/product -&gt; product链接</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create-system-product-symlink)</span></span><br><span class="line"><span class="comment"># 删除*.list文件</span></span><br><span class="line"><span class="variable">$(hide)</span> rm -rf <span class="variable">$@</span> <span class="variable">$@</span>.list <span class="variable">$(zip_root)</span></span><br><span class="line"><span class="comment"># 创建target file package目录</span></span><br><span class="line"><span class="variable">$(hide)</span> mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span> <span class="variable">$(zip_root)</span></span><br></pre></td></tr></table></figure>
<h4 id="1-3-recovery-as-boot处理"><a href="#1-3-recovery-as-boot处理" class="headerlink" title="1.3 recovery as boot处理"></a>1.3 recovery as boot处理</h4><p>若有定义recovery as boot为true，则将recovery/root，2ndbootloader，kernel，dtbo，cmdline等内容拷贝至recovery目录，否则将其直接拷入boot目录。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若BOARD_USES_RECOVERY_AS_BOOT为true，则处理recovery image相关目标</span></span><br><span class="line"><span class="keyword">ifneq</span> (,<span class="variable">$(INSTALLED_RECOVERYIMAGE_TARGET)</span><span class="variable">$(<span class="built_in">filter</span> true,<span class="variable">$(BOARD_USES_RECOVERY_AS_BOOT)</span>)</span>)</span><br><span class="line">    <span class="comment"># PRIVATE_RECOVERY_OUT即创建RECOVERY目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span></span><br><span class="line">    <span class="comment"># 将recovery/root目录拷至RECOVERY/RAMDISK目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_RECOVERY_ROOT_OUT)</span>,<span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/RAMDISK)</span></span><br><span class="line">    <span class="comment"># 若INSTALLED_KERNEL_TARGET为true,则将kernel拷贝至RECVOERY目录</span></span><br><span class="line">    <span class="keyword">ifdef</span> INSTALLED_KERNEL_TARGET</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_KERNEL_TARGET)</span> <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/kernel</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义INSTALLED_2NDBOOTLOADER_TARGET，则将2ndbootloader拷至RECOVERY目录并重命名为second</span></span><br><span class="line">    <span class="keyword">ifdef</span> INSTALLED_2NDBOOTLOADER_TARGET</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_2NDBOOTLOADER_TARGET)</span> <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/second</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义BOARD_INCLUDE_RECOVERY_DTBO，则将dtbo image目标拷至RECOVERY目录并重命名为recovery_dtbo</span></span><br><span class="line">    <span class="keyword">ifdef</span> BOARD_INCLUDE_RECOVERY_DTBO</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_DTBOIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/recovery_dtbo</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义INTERNAL_KERNEL_CMDLINE，则将cmdline拷至RECOVERY目录</span></span><br><span class="line">    <span class="keyword">ifdef</span> INTERNAL_KERNEL_CMDLINE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(INTERNAL_KERNEL_CMDLINE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/cmdline</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义BOARD_KERNEL_BASE，则将其写入RECOVERY目录base文件</span></span><br><span class="line">    <span class="keyword">ifdef</span> BOARD_KERNEL_BASE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(BOARD_KERNEL_BASE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/base</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义BOARD_KERNEL_BASE，则将其写入RECOVERY目录pagesize文件</span></span><br><span class="line">    <span class="keyword">ifdef</span> BOARD_KERNEL_PAGESIZE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(BOARD_KERNEL_PAGESIZE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/<span class="variable">$(PRIVATE_RECOVERY_OUT)</span>/pagesize</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 创建BOOT目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/BOOT</span><br><span class="line"><span class="comment"># 若BOARD_BUILD_SYSTEM_ROOT_IMAGE为true，则创建ROOT目录，并将root目录拷至ROOT目录，否则将root目录拷贝至BOOT/RAMDISK目录</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(BOARD_BUILD_SYSTEM_ROOT_IMAGE)</span>,true)</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/ROOT</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_ROOT_OUT)</span>,<span class="variable">$(zip_root)</span>/ROOT)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_ROOT_OUT)</span>,<span class="variable">$(zip_root)</span>/BOOT/RAMDISK)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若BOARD_USES_RECOVERY_AS_BOOT为false，则将kernel拷贝至BOOT目录</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(BOARD_USES_RECOVERY_AS_BOOT)</span>,true)</span><br><span class="line">    <span class="keyword">ifdef</span> INSTALLED_KERNEL_TARGET</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_KERNEL_TARGET)</span> <span class="variable">$(zip_root)</span>/BOOT/kernel</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若未定义INSTALLED_2NDBOOTLOADER_TARGET，则将2ndbootloader拷至BOOT目录并重命名为second</span></span><br><span class="line">    <span class="keyword">ifdef</span> INSTALLED_2NDBOOTLOADER_TARGET</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_2NDBOOTLOADER_TARGET)</span> <span class="variable">$(zip_root)</span>/BOOT/second</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若未定义INTERNAL_KERNEL_CMDLINE，则将cmdline拷至BOOT目录</span></span><br><span class="line">    <span class="keyword">ifdef</span> INTERNAL_KERNEL_CMDLINE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(INTERNAL_KERNEL_CMDLINE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/BOOT/cmdline</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若未定义BOARD_KERNEL_BASE，则将base写入BOOT目录base文件</span></span><br><span class="line">    <span class="keyword">ifdef</span> BOARD_KERNEL_BASE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(BOARD_KERNEL_BASE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/BOOT/base</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若未定义BOARD_KERNEL_PAGESIZE，则将base写入BOOT目录pagesize文件</span></span><br><span class="line">    <span class="keyword">ifdef</span> BOARD_KERNEL_PAGESIZE</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(BOARD_KERNEL_PAGESIZE)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/BOOT/pagesize</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h4 id="1-4-radio-system-vendor等img处理"><a href="#1-4-radio-system-vendor等img处理" class="headerlink" title="1.4 radio/system/vendor等img处理"></a>1.4 radio/system/vendor等img处理</h4><p>在target-files创建RADIO/VENDOR/SYSTEM等目录，并将out目录对应内容拷贝至此。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 创建RADIO目录，并按radio image层次目录将radio image目标拷入</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">foreach</span> t,<span class="variable">$(INSTALLED_RADIOIMAGE_TARGET)</span>,\</span></span><br><span class="line"><span class="variable">                mkdir -p <span class="variable">$(zip_root)</span>/RADIO; \</span></span><br><span class="line"><span class="variable">                cp <span class="variable">$(t)</span> <span class="variable">$(zip_root)</span>/RADIO/$(<span class="built_in">notdir</span> <span class="variable">$(t)</span>)</span>;)</span><br><span class="line">    <span class="comment"># 将system image源文件拷入SYSTEM目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(SYSTEMIMAGE_SOURCE_DIR)</span>,<span class="variable">$(zip_root)</span>/SYSTEM)</span></span><br><span class="line">    <span class="comment"># 将data目录拷入DATA目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_OUT_DATA)</span>,<span class="variable">$(zip_root)</span>/DATA)</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE，则将vendor目录拷入VENDOR目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_OUT_VENDOR)</span>,<span class="variable">$(zip_root)</span>/VENDOR)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE，则将product目录拷入PRODUCT目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_OUT_PRODUCT)</span>,<span class="variable">$(zip_root)</span>/PRODUCT)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义INSTALLED_SYSTEMOTHERIMAGE_TARGET，则将system_other目录拷入SYSTEM_OTHER目录</span></span><br><span class="line"><span class="keyword">ifdef</span> INSTALLED_SYSTEMOTHERIMAGE_TARGET</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> package_files-copy-root, \</span></span><br><span class="line"><span class="variable">        <span class="variable">$(TARGET_OUT_SYSTEM_OTHER)</span>,<span class="variable">$(zip_root)</span>/SYSTEM_OTHER)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 创建OTA目标，并将android-info.txt拷入OTA目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/OTA</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_ANDROID_INFO_TXT_TARGET)</span> <span class="variable">$(zip_root)</span>/OTA/</span><br><span class="line"><span class="comment"># 若system base fs非空，则将其拷至META目录</span></span><br><span class="line"><span class="keyword">ifneq</span> ($(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_SYSTEM_BASE_FS_PATH),)</span><br><span class="line">    <span class="variable">$(hide)</span> cp $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_SYSTEM_BASE_FS_PATH) \</span><br><span class="line">      <span class="variable">$(zip_root)</span>/META/<span class="variable">$(<span class="built_in">notdir</span> $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_SYSTEM_BASE_FS_PATH)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若vendor base fs非空，则将其拷至META目录</span></span><br><span class="line"><span class="keyword">ifneq</span> ($(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_VENDOR_BASE_FS_PATH),)</span><br><span class="line">    <span class="variable">$(hide)</span> cp $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_VENDOR_BASE_FS_PATH) \</span><br><span class="line">      <span class="variable">$(zip_root)</span>/META/<span class="variable">$(<span class="built_in">notdir</span> $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_VENDOR_BASE_FS_PATH)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若product base fs非空，则将其拷至META目录</span></span><br><span class="line"><span class="keyword">ifneq</span> ($(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_PRODUCT_BASE_FS_PATH),)</span><br><span class="line">    <span class="variable">$(hide)</span> cp $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_PRODUCT_BASE_FS_PATH) \</span><br><span class="line">      <span class="variable">$(zip_root)</span>/META/<span class="variable">$(<span class="built_in">notdir</span> $(PRODUCTS.<span class="variable">$(INTERNAL_PRODUCT)</span>.PRODUCT_PRODUCT_BASE_FS_PATH)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h4 id="1-5-ota-tool-apkcert-key-selinux处理处理"><a href="#1-5-ota-tool-apkcert-key-selinux处理处理" class="headerlink" title="1.5 ota tool/apkcert/key/selinux处理处理"></a>1.5 ota tool/apkcert/key/selinux处理处理</h4><p>若为Non A/B项目，则将ota tool拷入OTA/bin目录。<br>将apkcerts/tool/otakeys/file_contexts.bin拷入META目录。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若AB_OTA_UPDATER为false，则创建OTA/bin目录，并将updater拷入OTA/bin目录</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(AB_OTA_UPDATER)</span>,true)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(built_ota_tools)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/OTA/bin</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(PRIVATE_OTA_TOOLS)</span> <span class="variable">$(zip_root)</span>/OTA/bin/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 创建META目录，并将apkcerts.txt拷入META目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/META</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(APKCERTS_FILE)</span> <span class="variable">$(zip_root)</span>/META/apkcerts.txt</span><br><span class="line"><span class="comment"># 若tool_extension非空，则将releasetools拷入META目录</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(tool_extension)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(PRIVATE_TOOL_EXTENSION)</span> <span class="variable">$(zip_root)</span>/META/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 将release key写入META目录otakeys.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"<span class="variable">$(PRODUCT_OTA_PUBLIC_KEYS)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/META/otakeys.txt</span><br><span class="line">    <span class="comment"># 将selinux目录file_contexts.bin文件拷入META目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(SELINUX_FC)</span> <span class="variable">$(zip_root)</span>/META/file_contexts.bin</span><br></pre></td></tr></table></figure>
<h4 id="1-6-生成misc-info-txt文件"><a href="#1-6-生成misc-info-txt文件" class="headerlink" title="1.6 生成misc_info.txt文件"></a>1.6 生成misc_info.txt文件</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 将recovery api版本信息赋给recovery_api_version并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"recovery_api_version=<span class="variable">$(PRIVATE_RECOVERY_API_VERSION)</span>"</span> &gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将fstab版本信息赋给fstab_version并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"fstab_version=<span class="variable">$(PRIVATE_RECOVERY_FSTAB_VERSION)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="comment"># 若有定义BOARD_FLASH_BLOCK_SIZE，则将其赋给blocksize并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_FLASH_BLOCK_SIZE</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"blocksize=<span class="variable">$(BOARD_FLASH_BLOCK_SIZE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_BOOTIMAGE_PARTITION_SIZE，则将其赋给boot_siz并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_BOOTIMAGE_PARTITION_SIZE</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"boot_size=<span class="variable">$(BOARD_BOOTIMAGE_PARTITION_SIZE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若INSTALLED_RECOVERYIMAGE_TARGET为空，则将no_recovery=true写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(INSTALLED_RECOVERYIMAGE_TARGET)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"no_recovery=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_INCLUDE_RECOVERY_DTBO，则将include_recovery_dtbo=true写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_INCLUDE_RECOVERY_DTBO</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"include_recovery_dtbo=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_RECOVERYIMAGE_PARTITION_SIZE，则将其赋给recovery_size并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_RECOVERYIMAGE_PARTITION_SIZE</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"recovery_size=<span class="variable">$(BOARD_RECOVERYIMAGE_PARTITION_SIZE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS，则将其赋给recovery_mount_options，否则将DEFAULT_TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS赋给recovery_mount_options，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS</span><br><span class="line">    @<span class="comment"># TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS can be empty to indicate that nothing but defaults should be used.</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"recovery_mount_options=<span class="variable">$(TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"recovery_mount_options=<span class="variable">$(DEFAULT_TARGET_RECOVERY_FSTYPE_MOUNT_OPTIONS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 将PRIVATE_TOOL_EXTENSIONS赋给tool_extensions，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"tool_extensions=<span class="variable">$(PRIVATE_TOOL_EXTENSIONS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将DEFAULT_SYSTEM_DEV_CERTIFICATE赋给default_system_dev_certificate，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"default_system_dev_certificate=<span class="variable">$(DEFAULT_SYSTEM_DEV_CERTIFICATE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="comment"># 若有定义PRODUCT_EXTRA_RECOVERY_KEYS，则将其赋给extra_recovery_keys，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> PRODUCT_EXTRA_RECOVERY_KEYS</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"extra_recovery_keys=<span class="variable">$(PRODUCT_EXTRA_RECOVERY_KEYS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 将BOARD_MKBOOTIMG_ARGS赋给mkbootimg_args，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo 'mkbootimg_args=<span class="variable">$(BOARD_MKBOOTIMG_ARGS)</span>' &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将INTERNAL_MKBOOTIMG_VERSION_ARGS赋给mkbootimg_version_args，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo 'mkbootimg_version_args=<span class="variable">$(INTERNAL_MKBOOTIMG_VERSION_ARGS)</span>' &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将multistage_support=1写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"multistage_support=1"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将Dblockimgdiff_versions=3,4写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"blockimgdiff_versions=3,4"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="comment"># 若OEM_THUMBPRINT_PROPERTIES非空，则将其赋给oem_fingerprint_properties，，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(OEM_THUMBPRINT_PROPERTIES)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"oem_fingerprint_properties=<span class="variable">$(OEM_THUMBPRINT_PROPERTIES)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若SANITIZE_TARGET非空，则将userdata_img_with_data=true写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">strip</span> <span class="variable">$(SANITIZE_TARGET)</span>)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"userdata_img_with_data=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若BOARD_USES_FULL_RECOVERY_IMAGE为true，则将full_recovery_image=true写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(BOARD_USES_FULL_RECOVERY_IMAGE)</span>,true)</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"full_recovery_image=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_BPT_INPUT_FILES，则：</span></span><br><span class="line"><span class="comment"># 将board_bpt_enable=true写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_BPT_MAKE_TABLE_ARGS赋给board_bpt_make_table_args，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_BPT_INPUT_FILES赋给board_bpt_input_files，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_BPT_INPUT_FILES</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"board_bpt_enable=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"board_bpt_make_table_args=<span class="variable">$(BOARD_BPT_MAKE_TABLE_ARGS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"board_bpt_input_files=<span class="variable">$(BOARD_BPT_INPUT_FILES)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_BPT_DISK_SIZE，则将其赋给board_bpt_disk_size，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_BPT_DISK_SIZE</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"board_bpt_disk_size=<span class="variable">$(BOARD_BPT_DISK_SIZE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 将userimage prop写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> generate-userimage-prop-dictionary, <span class="variable">$(zip_root)</span>/META/misc_info.txt)</span></span><br></pre></td></tr></table></figure>
<h4 id="1-7-将AVB信息到misc-info中"><a href="#1-7-将AVB信息到misc-info中" class="headerlink" title="1.7 将AVB信息到misc_info中"></a>1.7 将AVB信息到misc_info中</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若BOARD_AVB_ENABLE为true，则：</span></span><br><span class="line"><span class="comment"># 将avb_enable=true"写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_AVB_KEY_PATH赋给avb_vbmeta_key_path，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_AVB_ALGORITHM赋给avb_vbmeta_algorithm，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_AVB_MAKE_VBMETA_IMAGE_ARGS赋给avb_vbmeta_args，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="comment"># 将BOARD_AVB_BOOT_ADD_HASH_FOOTER_ARGS赋给avb_boot_add_hash_footer_args，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(BOARD_AVB_ENABLE)</span>,true)</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_enable=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_vbmeta_key_path=<span class="variable">$(BOARD_AVB_KEY_PATH)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_vbmeta_algorithm=<span class="variable">$(BOARD_AVB_ALGORITHM)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_vbmeta_args=<span class="variable">$(BOARD_AVB_MAKE_VBMETA_IMAGE_ARGS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_boot_add_hash_footer_args=<span class="variable">$(BOARD_AVB_BOOT_ADD_HASH_FOOTER_ARGS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 若有定义BOARD_AVB_BOOT_KEY_PATH，则：</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_BOOT_KEY_PATH赋给avb_boot_key_path，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_BOOT_ALGORITHM赋给avb_boot_algorithm，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_BOOT_ROLLBACK_INDEX_LOCATION赋给avb_boot_rollback_index_location，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_AVB_BOOT_KEY_PATH</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_boot_key_path=<span class="variable">$(BOARD_AVB_BOOT_KEY_PATH)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_boot_algorithm=<span class="variable">$(BOARD_AVB_BOOT_ALGORITHM)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_boot_rollback_index_location=<span class="variable">$(BOARD_AVB_BOOT_ROLLBACK_INDEX_LOCATION)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_RECOVERY_ADD_HASH_FOOTER_ARGS赋给avb_recovery_add_hash_footer_args，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_recovery_add_hash_footer_args=<span class="variable">$(BOARD_AVB_RECOVERY_ADD_HASH_FOOTER_ARGS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 若有定义BOARD_AVB_RECOVERY_KEY_PATH，则：</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_RECOVERY_KEY_PATH赋给avb_recovery_key_path，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_RECOVERY_ALGORITHM赋给avb_recovery_algorithm，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_RECOVERY_ROLLBACK_INDEX_LOCATION赋给avb_recovery_rollback_index_location，并写入META目录misc_info.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_AVB_RECOVERY_KEY_PATH</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_recovery_key_path=<span class="variable">$(BOARD_AVB_RECOVERY_KEY_PATH)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_recovery_algorithm=<span class="variable">$(BOARD_AVB_RECOVERY_ALGORITHM)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"avb_recovery_rollback_index_location=<span class="variable">$(BOARD_AVB_RECOVERY_ROLLBACK_INDEX_LOCATION)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h4 id="1-8-将A-B-Updater信息写入misc-info"><a href="#1-8-将A-B-Updater信息写入misc-info" class="headerlink" title="1.8 将A/B Updater信息写入misc_info"></a>1.8 将A/B Updater信息写入misc_info</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AB_OTA_UPDATER为true</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(AB_OTA_UPDATER)</span>,true)</span><br><span class="line">    <span class="comment"># 将system/update_engine/update_engine.conf拷入META目录update_engine_config.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(TOPDIR)</span>system/update_engine/update_engine.conf <span class="variable">$(zip_root)</span>/META/update_engine_config.txt</span><br><span class="line">    <span class="comment"># 将AB_OTA_PARTITIONS定义的内容写入META目录ab_partitions.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> for part in <span class="variable">$(AB_OTA_PARTITIONS)</span>; do \</span><br><span class="line">      echo <span class="string">"$$&#123;part&#125;"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/ab_partitions.txt; \</span><br><span class="line">    done</span><br><span class="line">    <span class="comment"># 将AB_OTA_POSTINSTALL_CONFIG配置的值写入META目录postinstall_config.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> for conf in <span class="variable">$(AB_OTA_POSTINSTALL_CONFIG)</span>; do \</span><br><span class="line">      echo <span class="string">"$$&#123;conf&#125;"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/postinstall_config.txt; \</span><br><span class="line">    done</span><br><span class="line">    <span class="comment"># 将TARGET_BUILD_VARIANT赋给build_type，并写入META目录misc_info文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"build_type=<span class="variable">$(TARGET_BUILD_VARIANT)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 将ab_update=true写入META目录misc_info文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"ab_update=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 若有定义BRILLO_VENDOR_PARTITIONS，则创建VENDOR_IMAGE目录，并将其内容拷入</span></span><br><span class="line">    <span class="keyword">ifdef</span> BRILLO_VENDOR_PARTITIONS</span><br><span class="line">        <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/VENDOR_IMAGES</span><br><span class="line">        <span class="variable">$(hide)</span> for f in <span class="variable">$(BRILLO_VENDOR_PARTITIONS)</span>; do \</span><br><span class="line">        pair1=<span class="string">"$$(echo $$f | awk -F':' '&#123;print $$1&#125;')"</span>; \</span><br><span class="line">        pair2=<span class="string">"$$(echo $$f | awk -F':' '&#123;print $$2&#125;')"</span>; \</span><br><span class="line">        src=$$&#123;pair1&#125;/$$&#123;pair2&#125;; \</span><br><span class="line">        dest=<span class="variable">$(zip_root)</span>/VENDOR_IMAGES/$$&#123;pair2&#125;; \</span><br><span class="line">        mkdir -p $<span class="variable">$(dirname "$$&#123;dest&#125;")</span>; \</span><br><span class="line">        cp $$&#123;src&#125; $$&#123;dest&#125;; \</span><br><span class="line">        done;</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 若有定义OSRELEASED_DIRECTORY，则将product_id，product_version，system_version拷贝至META目录</span></span><br><span class="line">    <span class="keyword">ifdef</span> OSRELEASED_DIRECTORY</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(TARGET_OUT_OEM)</span>/<span class="variable">$(OSRELEASED_DIRECTORY)</span>/product_id <span class="variable">$(zip_root)</span>/META/product_id.txt</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(TARGET_OUT_OEM)</span>/<span class="variable">$(OSRELEASED_DIRECTORY)</span>/product_version <span class="variable">$(zip_root)</span>/META/product_version.txt</span><br><span class="line">        <span class="variable">$(hide)</span> cp <span class="variable">$(TARGET_OUT_ETC)</span>/<span class="variable">$(OSRELEASED_DIRECTORY)</span>/system_version <span class="variable">$(zip_root)</span>/META/system_version.txt</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h4 id="1-9-处理recovery及预编译的vendor-boot-dtbo等imag"><a href="#1-9-处理recovery及预编译的vendor-boot-dtbo等imag" class="headerlink" title="1.9 处理recovery及预编译的vendor/boot/dtbo等imag"></a>1.9 处理recovery及预编译的vendor/boot/dtbo等imag</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若INSTALLED_RECOVERYIMAGE_TARGET非空，则调用make_recovery_patch脚本</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(INSTALLED_RECOVERYIMAGE_TARGET)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> PATH=<span class="variable">$(<span class="built_in">foreach</span> p,<span class="variable">$(INTERNAL_USERIMAGES_BINARY_PATHS)</span>,<span class="variable">$(p)</span>:)</span>$$PATH MKBOOTIMG=<span class="variable">$(MKBOOTIMG)</span> \</span><br><span class="line">        build/make/tools/releasetools/make_recovery_patch <span class="variable">$(zip_root)</span> <span class="variable">$(zip_root)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若BREAKPAD_GENERATE_SYMBOLS为true，则将breakpad加入BREAKPAD目录</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(BREAKPAD_GENERATE_SYMBOLS)</span>,true)</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(ACP)</span> -r <span class="variable">$(TARGET_OUT_BREAKPAD)</span> <span class="variable">$(zip_root)</span>/BREAKPAD</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_BUILD_DISABLED_VBMETAIMAGE，则将vbmeta image目标拷入IMAGES目录</span></span><br><span class="line"><span class="keyword">ifeq</span> (true,<span class="variable">$(BOARD_BUILD_DISABLED_VBMETAIMAGE)</span>)</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/IMAGES</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_VBMETAIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/IMAGES/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PREBUILT_VENDORIMAGE，则将vendor image目标拷入IMAGES目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PREBUILT_VENDORIMAGE</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/IMAGES</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_VENDORIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/IMAGES/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PREBUILT_PRODUCTIMAGE，则将product image目标拷入IMAGES目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PREBUILT_PRODUCTIMAGE</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/IMAGES</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_PRODUCTIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/IMAGES/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PREBUILT_BOOTIMAGE，则将boot image目标拷入IMAGES目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PREBUILT_BOOTIMAGE</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/IMAGES</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_BOOTIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/IMAGES/</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PREBUILT_DTBOIMAGE，则创建PREBUILT_IMAGES目录，并将dtbo image拷入PREBUILT_IMAGES目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PREBUILT_DTBOIMAGE</span><br><span class="line">    <span class="variable">$(hide)</span> mkdir -p <span class="variable">$(zip_root)</span>/PREBUILT_IMAGES</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(INSTALLED_DTBOIMAGE_TARGET)</span> <span class="variable">$(zip_root)</span>/PREBUILT_IMAGES/</span><br><span class="line">    <span class="comment"># 将has_dtbo=true写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> echo <span class="string">"has_dtbo=true"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">    <span class="comment"># 若BOARD_AVB_ENABLE为true,则：</span></span><br><span class="line">    <span class="comment"># 将BOARD_DTBOIMG_PARTITION_SIZE赋给dtbo_size，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="comment"># 将BOARD_AVB_DTBO_ADD_HASH_FOOTER_ARGS赋给avb_dtbo_add_hash_footer_args，并写入META目录misc_info.txt文件</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(BOARD_AVB_ENABLE)</span>,true)</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"dtbo_size=<span class="variable">$(BOARD_DTBOIMG_PARTITION_SIZE)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">        <span class="variable">$(hide)</span> echo <span class="string">"avb_dtbo_add_hash_footer_args=<span class="variable">$(BOARD_AVB_DTBO_ADD_HASH_FOOTER_ARGS)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">        <span class="comment"># 若有定义BOARD_AVB_DTBO_KEY_PATH，则：</span></span><br><span class="line">        <span class="comment"># 将BOARD_AVB_DTBO_KEY_PATH赋给avb_dtbo_key_path，并写入META目录misc_info.txt文件</span></span><br><span class="line">        <span class="comment"># 将BOARD_AVB_DTBO_ALGORITHM赋给avb_dtbo_algorithm，并写入META目录misc_info.txt文件</span></span><br><span class="line">        <span class="comment"># 将BOARD_AVB_DTBO_ROLLBACK_INDEX_LOCATION赋给avb_dtbo_rollback_index_location，并写入META目录misc_info.txt文件</span></span><br><span class="line">        <span class="keyword">ifdef</span> BOARD_AVB_DTBO_KEY_PATH</span><br><span class="line">            <span class="variable">$(hide)</span> echo <span class="string">"avb_dtbo_key_path=<span class="variable">$(BOARD_AVB_DTBO_KEY_PATH)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">            <span class="variable">$(hide)</span> echo <span class="string">"avb_dtbo_algorithm=<span class="variable">$(BOARD_AVB_DTBO_ALGORITHM)</span>"</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">            <span class="variable">$(hide)</span> echo <span class="string">"avb_dtbo_rollback_index_location=<span class="variable">$(BOARD_AVB_DTBO_ROLLBACK_INDEX_LOCATION)</span>"</span> \</span><br><span class="line">                &gt;&gt; <span class="variable">$(zip_root)</span>/META/misc_info.txt</span><br><span class="line">        <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h4 id="1-10-处理radio-vendor-system等img的file-config内容"><a href="#1-10-处理radio-vendor-system等img的file-config内容" class="headerlink" title="1.10 处理radio/vendor/system等img的file config内容"></a>1.10 处理radio/vendor/system等img的file config内容</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 将radio image信息写入META目录pack_radioimages.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">foreach</span> part,<span class="variable">$(BOARD_PACK_RADIOIMAGES)</span>, \</span></span><br><span class="line"><span class="variable">        echo <span class="variable">$(part)</span> &gt;&gt; <span class="variable">$(zip_root)</span>/META/pack_radioimages.txt;)</span></span><br><span class="line">    <span class="comment"># 将则将运行fs_config，将system相关config写入META目录filesystem_config.txt文件</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/SYSTEM,system/)</span> &gt; <span class="variable">$(zip_root)</span>/META/filesystem_config.txt</span><br><span class="line"><span class="comment"># 若有定义BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE，则将运行fs_config，将vendor相关config写入META目录vendor_filesystem_config.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/VENDOR,vendor/)</span> &gt; <span class="variable">$(zip_root)</span>/META/vendor_filesystem_config.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE，则将运行fs_config，将product相关config写入META目录product_filesystem_config.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/PRODUCT,product/)</span> &gt; <span class="variable">$(zip_root)</span>/META/product_filesystem_config.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若BOARD_BUILD_SYSTEM_ROOT_IMAGE为true，则运行fs_config，将root相关config写入META目录root_filesystem_config.txt文件,否则将ramdisk写入META目录boot_filesystem_config.txt文件</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(BOARD_BUILD_SYSTEM_ROOT_IMAGE)</span>,true)</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/ROOT,)</span> &gt; <span class="variable">$(zip_root)</span>/META/root_filesystem_config.txt</span><br><span class="line">    <span class="comment"># 若BOARD_USES_RECOVERY_AS_BOOT为true，则运行fs_config，将boot_ramdisk相关config写入META目录boot_filesystem_config.txt文件</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(BOARD_USES_RECOVERY_AS_BOOT)</span>,true)</span><br><span class="line">        <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/BOOT/RAMDISK,)</span> &gt; <span class="variable">$(zip_root)</span>/META/boot_filesystem_config.txt</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/BOOT/RAMDISK,)</span> &gt; <span class="variable">$(zip_root)</span>/META/boot_filesystem_config.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若INSTALLED_RECOVERYIMAGE_TARGET非空，则运行fs_config，将recovery_ramdisk相关config写入META目录recovery_filesystem_config.txt文件</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(INSTALLED_RECOVERYIMAGE_TARGET)</span>,)</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/RECOVERY/RAMDISK,)</span> &gt; <span class="variable">$(zip_root)</span>/META/recovery_filesystem_config.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义INSTALLED_SYSTEMOTHERIMAGE_TARGET，则运行fs_config，将system_other相关config写入META目录system_other_filesystem_config.txt文件</span></span><br><span class="line"><span class="keyword">ifdef</span> INSTALLED_SYSTEMOTHERIMAGE_TARGET</span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(<span class="built_in">call</span> fs_config,<span class="variable">$(zip_root)</span>/SYSTEM_OTHER,system/)</span> &gt; <span class="variable">$(zip_root)</span>/META/system_other_filesystem_config.txt</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 拷贝system_manifest.xml，system_matrix.xml至META目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(BUILT_SYSTEM_MANIFEST)</span> <span class="variable">$(zip_root)</span>/META/system_manifest.xml</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(BUILT_SYSTEM_COMPATIBILITY_MATRIX)</span> <span class="variable">$(zip_root)</span>/META/system_matrix.xml</span><br><span class="line"><span class="comment"># 若有定义BUILT_VENDOR_MANIFEST，则将vendor_manifest.xml拷至META目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BUILT_VENDOR_MANIFEST</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(BUILT_VENDOR_MANIFEST)</span> <span class="variable">$(zip_root)</span>/META/vendor_manifest.xml</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># 若有定义BUILT_VENDOR_MATRIX，则将vendor_matrix.xml拷至META目录</span></span><br><span class="line"><span class="keyword">ifdef</span> BUILT_VENDOR_MATRIX</span><br><span class="line">    <span class="variable">$(hide)</span> cp <span class="variable">$(BUILT_VENDOR_MATRIX)</span> <span class="variable">$(zip_root)</span>/META/vendor_matrix.xml</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">    <span class="comment"># 调用add_img_to_target_files脚本，将诸image拷入IMAGES/RADIO等目录</span></span><br><span class="line">    <span class="variable">$(hide)</span> PATH=<span class="variable">$(<span class="built_in">foreach</span> p,<span class="variable">$(INTERNAL_USERIMAGES_BINARY_PATHS)</span>,<span class="variable">$(p)</span>:)</span>$$PATH MKBOOTIMG=<span class="variable">$(MKBOOTIMG)</span> \</span><br><span class="line">        build/make/tools/releasetools/add_img_to_target_files -a -v -p <span class="variable">$(HOST_OUT)</span> <span class="variable">$(zip_root)</span></span><br><span class="line">    <span class="comment"># 查找META目录并按顺序输出至*.list文件中</span></span><br><span class="line">    <span class="variable">$(hide)</span> find <span class="variable">$(zip_root)</span>/META | sort &gt;<span class="variable">$@</span>.list</span><br><span class="line">    <span class="variable">$(hide)</span> find <span class="variable">$(zip_root)</span> -path <span class="variable">$(zip_root)</span>/META -prune -o -print | sort &gt;&gt;<span class="variable">$@</span>.list</span><br><span class="line">    <span class="comment"># 按*.list文件进行target file package的打包</span></span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(SOONG_ZIP)</span> -d -o <span class="variable">$@</span> -C <span class="variable">$(zip_root)</span> -l <span class="variable">$@</span>.list</span><br></pre></td></tr></table></figure>
<h4 id="1-11-定义target-files-package模块编译"><a href="#1-11-定义target-files-package模块编译" class="headerlink" title="1.11 定义target-files-package模块编译"></a>1.11 定义target-files-package模块编译</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于make target-files-package</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: target-files-package</span></span><br><span class="line"><span class="section">target-files-package: <span class="variable">$(BUILT_TARGET_FILES_PACKAGE)</span></span></span><br><span class="line"><span class="comment"># 检测到编译指令包含，则执行BUILD target相关操作</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">filter</span> <span class="variable">$(MAKECMDGOALS)</span>,target-files-package)</span>,)</span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> dist-for-goals, target-files-package, <span class="variable">$(BUILT_TARGET_FILES_PACKAGE)</span>)</span></span><br><span class="line">endift-for-goals, target-files-package, <span class="variable">$(BUILT_TARGET_FILES_PACKAGE)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Build/" rel="tag"># Build</a>
          
            <a href="/tags/Makefile/" rel="tag"># Makefile</a>
          
            <a href="/tags/OTA/" rel="tag"># OTA</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/12/OTA/OTA升级之解密uncrypt/" rel="next" title="OTA 升级之解密 uncrypt">
                <i class="fa fa-chevron-left"></i> OTA 升级之解密 uncrypt
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/10/Build/Update-delta-package编译脚本解析/" rel="prev" title="Update delta package 编译脚本解析">
                Update delta package 编译脚本解析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/light_house.jpg" alt="Young">
            
              <p class="site-author-name" itemprop="name">Young</p>
              <div class="site-description motion-element" itemprop="description">自在独行</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">99</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-编译target-files依赖的目标"><span class="nav-text">1.1 编译target files依赖的目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-创建target-files目录"><span class="nav-text">1.2 创建target files目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-recovery-as-boot处理"><span class="nav-text">1.3 recovery as boot处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-radio-system-vendor等img处理"><span class="nav-text">1.4 radio/system/vendor等img处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-ota-tool-apkcert-key-selinux处理处理"><span class="nav-text">1.5 ota tool/apkcert/key/selinux处理处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-6-生成misc-info-txt文件"><span class="nav-text">1.6 生成misc_info.txt文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-7-将AVB信息到misc-info中"><span class="nav-text">1.7 将AVB信息到misc_info中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-8-将A-B-Updater信息写入misc-info"><span class="nav-text">1.8 将A/B Updater信息写入misc_info</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-9-处理recovery及预编译的vendor-boot-dtbo等imag"><span class="nav-text">1.9 处理recovery及预编译的vendor/boot/dtbo等imag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-10-处理radio-vendor-system等img的file-config内容"><span class="nav-text">1.10 处理radio/vendor/system等img的file config内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-11-定义target-files-package模块编译"><span class="nav-text">1.11 定义target-files-package模块编译</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Young</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  
<style>
  .copy-btn {
    display: inline-block;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 700;
    line-height: 20px;
    color: #333;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
    
    user-select: none;
    outline: 0;
  }

  .highlight-wrap .copy-btn {
    transition: opacity .3s ease-in-out;
    opacity: 0;
    padding: 2px 6px;
    position: absolute;
    
      right: 4px;
      top: 8px;
    
  }

  .highlight-wrap:hover .copy-btn,
  .highlight-wrap .copy-btn:focus {
    opacity: 1;
  }

  .highlight-wrap {
    position: relative;
  }
</style>
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


</body>
</html>
